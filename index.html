<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




















  
  
  <link rel="stylesheet" href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5">







  

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.2/css/font-awesome.min.css">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=7.0.1">


  <link rel="mask-icon" href="/images/safari-pinned-tab.svg?v=7.0.1" color="#222">


  <link rel="manifest" href="/images/manifest.json">


  <meta name="msapplication-config" content="/images/browserconfig.xml">





<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false,"dimmer":false},
    fancybox: true,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="~黑哈等你回家~">
<meta name="keywords" content="Spring Java Swift Openstack Docker Go Python Antd ReactJS">
<meta property="og:type" content="website">
<meta property="og:title" content="微笑卡卡西">
<meta property="og:url" content="http://dragonetail.github.io/index.html">
<meta property="og:site_name" content="微笑卡卡西">
<meta property="og:description" content="~黑哈等你回家~">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="微笑卡卡西">
<meta name="twitter:description" content="~黑哈等你回家~">






  <link rel="canonical" href="http://dragonetail.github.io/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>微笑卡卡西</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">微笑卡卡西</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">~黑哈瑞之家~</h1>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://dragonetail.github.io/2019/07/16/BACnet-101-BACnet介绍/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黑哈">
      <meta itemprop="description" content="~黑哈等你回家~">
      <meta itemprop="image" content="/images/blackharry1.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="微笑卡卡西">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/16/BACnet-101-BACnet介绍/" class="post-title-link" itemprop="url">BACnet 101 - BACnet介绍</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-07-16 11:07:26 / 修改时间：11:09:14" itemprop="dateCreated datePublished" datetime="2019-07-16T11:07:26+08:00">2019-07-16</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/IoT/" itemprop="url" rel="index"><span itemprop="name">IoT</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/IoT/BACnet/" itemprop="url" rel="index"><span itemprop="name">BACnet</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="BACnet-101-BACnet介绍"><a href="#BACnet-101-BACnet介绍" class="headerlink" title="BACnet 101 - BACnet介绍"></a>BACnet 101 - BACnet介绍</h1><p>Ref： <a href="https://www.csimn.com/CSI_pages/BACnet101.html" target="_blank" rel="noopener">https://www.csimn.com/CSI_pages/BACnet101.html</a></p>
<h3 id="BACnet概要视图"><a href="#BACnet概要视图" class="headerlink" title="BACnet概要视图"></a>BACnet概要视图</h3><p>BACnet代表建筑自动化和控制网络。它由ASHRAE于1996年正式发布，并已被批准为ISO标准16454-5，并正在成为欧盟的标准。</p>
<p>BACnet IP和BACnet MS/TP是标识用于在网络上传输BACnet数据包的物理层(IP或MS/TP)的名称。至少还定义了另外三个物理层，并在一定程度上使用它们。我们将在本网站上讨论IP和MS/TP，因为这是两个最常见的物理层，而且这两个物理层是控制解决方案在其产品线中支持的。</p>
<p><font color="blue">Modbus谈论寄存器，BACnet谈论对象和对象属性。</font>例如，传感器就是一个对象。如果它的属性是它的现值，这个属性在BACnet中被称为，现值属性（The Present Value property）。传感器很可能是两种对象类型之一:模拟输入(温度、湿度等)或二进制输入(感应传感器、开关等)。最常用的属性是现值，但还需要其他属性。其他属性包括状态标志(故障、服务停止)、可靠性，以及其他一些可选的属性，如高限制和低限制。</p>
<p>更多更好的Backnet资料，请参考<a href="http://www.bacnet.org](http://www.bacnet.org/Tutorial/index.html)" target="_blank" rel="noopener">www.bacnet.org](http://www.bacnet.org/Tutorial/index.html)</a>.</p>
<h3 id="BACnet的基础背景知识"><a href="#BACnet的基础背景知识" class="headerlink" title="BACnet的基础背景知识"></a>BACnet的基础背景知识</h3><p>BACnet设备在网络上定义为“对象”的集合Oobjecs）。典型的对象包括模拟输入、模拟输出、二进制输入、二进制输出和更复杂的对象，如调度。主要通过网络对对象的属性读写进行消息处理。模拟输入最常引用的属性是“现值（Present Value）”，这通常意味着来自传感器或物理设备的数据。与模拟输入对象相关的其他属性，例如，包括故障状态、可靠性、对象名称、最小和最大限制等。BACnet协议标准为每个对象类型定义了必需的和可选的属性。BACnet设备的制造商文档将列出设备中包含哪些对象类型，以及每个对象中包含哪些可选属性。</p>
<p>除了对象的定义，BACnet协议还定义了“服务（Services）”。这些服务包括对象访问服务、警报和事件服务、文件访问服务等等。对象访问服务是最常用的，因为它们提供对对象属性的基本“读/写”访问。</p>
<p>访问对象属性需要指定以下参数:</p>
<ul>
<li><p>设备实例(即，网络上的哪个设备)</p>
</li>
<li><p>对象类型(模拟输入、二进制输入等)</p>
</li>
<li><p>对象实例(即，哪个模拟输入)</p>
</li>
<li><p>属性(当前值、对象名称、状态标志等)</p>
</li>
</ul>
<p>输入对象（Input Objects）很简单，它们只有一个与之关联的“现值”。输出对象（Output Objects）被称为“可指令的（commandable）”，它们更加有趣。因为这个创造了多个算法一起控制一个对象的可能，通过有优先级的指令请求（Command Request）来控制对象，多个指令的时候最高优先级的指令有效；当高优先级指令被取消（Relinquished）时，次一优先级的指令接替生效。对象会维护一个指令优先队列来管理所有的指令（共有16个优先级别）。</p>
<p>因此，对于输出对象的操作需要额外两个参数：</p>
<ul>
<li>指令优先级</li>
<li>对应优先级上指令的级别</li>
</ul>
<p>对一个”可指令的”对象去读它的现值(Present Value)，则这个读的指令将会是最高优先级的，并且不可被取消。对于其他指令，通过向可执行的对象发送”取消(relinquish)”即可（这个应该是一个特殊的访问方式，应该需要制定之前的指令信息才行）。</p>
<p><strong>BACnet物理层（Physical Layer）</strong></p>
<p>BACnet协议定义了用于物理电信号、寻址、网络访问、错误检查、流控、表示和消息格式等。该协议侧重于构建自动化应用程序。</p>
<p><strong>BACnet IP</strong></p>
<p>BACnet IP使用一个标准的UDP/IP堆栈来发送和接收消息(参见下面UDP/IP的定义)。在大多数情况下，可以在MS/TP链接上找到的包被封装在UDP/IP包中，称为BACnet IP。设备使用IP地址和以太网MAC地址，就像其他UDP/IP网络设备一样。没有主从令牌传递的概念，因为以太网本质上是自动对等的。设备只是随意地将数据传输给它们的目标接收方，让以太网根据需要处理数据包冲突和重试。</p>
<p><strong>BACnet MS/TP</strong></p>
<p>MS/TP代表主从令牌传递。当链路上的每个设备都有令牌时，它被认为是“主设备”。如果不需要立即使用令牌，则需要将令牌传递给下一个设备。这是“令牌传递”部分。链路上当前没有令牌的所有设备都被视为从设备，并被期望侦听当前主设备可能为它提供的任何消息。因为所有的设备轮流成为主设备，所以这个链接实际上是点对点的。</p>
<p><strong>BACnet Application Layer</strong></p>
<p>真正有意思的地方，所有消息处理都在应用层处理，包括设备寻址。IP地址将通过UDP/IP堆栈层获得一个BACnet包。然后应用程序层决定如何处理BACnet消息。可能的消息类型有一个完整的列表，但是最常用的是“读取现值（read present value property）”，另一个“最常用”的是COV通知(值的更改，Change of Value)。</p>
<hr>
<p><strong>BACnet术语表</strong></p>
<p><strong>UDP/IP</strong> - 大家都听说过TCP/IP，与这个一样，UDP/IP也是一个常见的以太网协议栈，不同之处在于TCP是一个”连接(connection)”协议，而UDP是一个”无连接(connectionless)”协议；TCP协议更安全，但为了连接需要额外的开销来确保数据包的安全送达，而UDP速度和效率更高。BACNet IP使用UDP协议，主要原因是BACnet的消息通常都很短，并且彼此独立没有依赖。</p>
<p><strong>Object</strong> - 构成BACnet设备的传感器，执行器或其他功能元素的引用概念，属于协议的一部分；常用的对象有模拟输入对象和模拟输出对象。</p>
<p><strong>Object Property</strong> - 每个对象都具有BACnet协议所需的几个属性。最常用的属性是现值。其他常见属性包括可靠性和状态标志。对象的可选属性，如模拟输入，包括最小和最大范围，高和低的限制，等等。</p>
<p><strong>COV</strong> - Change Of Value - 当设备对象的属性值根据默认参数、或者写指令变化的时候，可以通过向设备订阅COV通知来获取COV通知消息（意译，需要跟进测试确认）。</p>
<p><strong>BBMD</strong> - BACnet/IP广播管理设备(BACnet/IP Broadcast Management Device)，用于跨大型网络的BACnet实现。BACnet典型的应用场景在一个园区，尽管在协议涉及上支持广域全国范围的网络建设。BACnet设备的运行，需要广播机制来广播消息。标准的IP技术在路由网关规定是不转发广播消息的，BBMD设备在多个不同网络域(IP子网)中进行广播转发到本地网络，来实现跨IP网络的BACnet/IP网络广播实现。IP域(子网中)只有一个设备充当BBMD即可实现广播消息的转发。(目前场景中，如果只在一个子网中建设BACnet，不用考虑BBMD的构建)</p>
<p><strong>MS/TP Mac Address  or Station ID</strong> - 这是一个8位数字，对于主/从设备来说是0-127。此Mac地址在RS-485链路上本地使用，用于链路上的物理地址设备，不经过路由器。它相当于Modbus RTU从地址。</p>
<p><strong>MS/TP Max Masters</strong> - 通过发起”主设备投票(poll for master)的活动来决定MS/TP Link网络中有多少设备可以作为主设备，如果所有的设备都不匹配，会发生不可预期问题。</p>
<p><strong>BACnet IP Addressing</strong> - 标准以太网IP地址用于标识IP网络上的设备。IP地址用于物理路由网络上的消息，同时用BACnet设备实例标识BACnet系统中的设备。</p>
<p><strong>Device Instance</strong> - 这是与BACnet有关的逻辑地址。无论是在MS/TP链路还是IP网络上，设备实例在所有子网和路由链路上都是惟一的。(补充：访问设备的参数顺序为：设备示例、对象类型、对象示例、属性)</p>
<p><strong>Client/Server versus Master/Slave</strong> - 我们倾向于在MS/TP级别考虑主服务器和从服务器，当我们讨论IP网络时，我们开始考虑客户机/服务器。在功能上，客户机和主服务器是同步的，而服务器和从服务器是同步的。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://dragonetail.github.io/2019/07/07/JPA中Model主键使用UUID/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黑哈">
      <meta itemprop="description" content="~黑哈等你回家~">
      <meta itemprop="image" content="/images/blackharry1.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="微笑卡卡西">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/07/07/JPA中Model主键使用UUID/" class="post-title-link" itemprop="url">JPA中Model主键使用UUID</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-07-07 17:43:51 / 修改时间：18:04:38" itemprop="dateCreated datePublished" datetime="2019-07-07T17:43:51+08:00">2019-07-07</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/技术/" itemprop="url" rel="index"><span itemprop="name">技术</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>使用Spring JPA项目进行开发，有关Model的设计，PK如何选择一直是个课题，特别对于集群和微服务的部署架构引入进来之后，一直在找一个平衡的解决方案，最近一个项目中又深入讨论了这个问题，参考国外一个博客<a href="https://phauer.com/2016/uuids-hibernate-mysql/的内容，翻译整理如下，供以后参考。" target="_blank" rel="noopener">https://phauer.com/2016/uuids-hibernate-mysql/的内容，翻译整理如下，供以后参考。</a></p>
<h1 id="关于数据库PK和UUID选择-MySQL"><a href="#关于数据库PK和UUID选择-MySQL" class="headerlink" title="关于数据库PK和UUID选择(MySQL)"></a>关于数据库PK和UUID选择(MySQL)</h1><ul>
<li><p>参考翻译自：<a href="https://phauer.com/2016/uuids-hibernate-mysql/" target="_blank" rel="noopener">https://phauer.com/2016/uuids-hibernate-mysql/</a></p>
</li>
<li><p>目的：考量数据库PK的选择和UUID的使用</p>
</li>
<li><p><strong>使用UUID的优势：</strong></p>
<ul>
<li>UUID全局唯一；</li>
<li>跨数据库唯一，合并数据，没有主键冲突；</li>
<li>分布式复制和存储(分布式数据库)方便简单；</li>
<li>可以随时生成UUID，不需要数据库支撑，方便测试和批量数据生成；</li>
<li>自动增量ID容易猜测会导致安全问题。</li>
</ul>
</li>
<li><p><strong>使用UUID的缺点：</strong></p>
<ul>
<li>数据库索引的空间大小增大；单个UUID需要16个字节，普通int只需要4个字节；</li>
<li>使用数据库SQL进行特定数据查询时会更加麻烦，下面会详细描述；</li>
<li>REST接口中使用UUID会增加payload的大小。</li>
</ul>
</li>
<li><p><strong>使用UUID创建表：</strong></p>
<ul>
<li>不建议使用<code>VARCHAR(36)</code>作为UUID数据类型，建议使用<code>BINARY(16)</code>作为字段类型；会降低空间占用，16个字节，没有字符串中的中线字符，数据库索引也会更快；</li>
<li>不过，这样会造成SQL查询稍稍复杂些。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> product (</span><br><span class="line">   <span class="string">`id`</span> <span class="built_in">BINARY</span>(<span class="number">16</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> primary <span class="keyword">key</span></span><br><span class="line">   ,<span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">64</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>JPA映射：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Id</span></span><br><span class="line"><span class="meta">@GeneratedValue</span>(generator = <span class="string">"uuid2"</span>)</span><br><span class="line"><span class="meta">@GenericGenerator</span>(name = <span class="string">"uuid2"</span>, strategy = <span class="string">"uuid2"</span>)</span><br><span class="line"><span class="meta">@Column</span>(columnDefinition = <span class="string">"BINARY(16)"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>SQL脚本生成UUID</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">uuid</span>(); <span class="comment">/*dbe07414-49d1-11e6-b7a7-0242ac140002*/</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>插入UUID数据</strong></p>
<ul>
<li>uuid()函数返回字符串，包含中线字符，需要使用replace去掉中线字符，然后使用unhex()函数转换十六进制可看字符到UUID数值二进制，最终存入<code>BINARY(16)</code>字段中。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> product <span class="keyword">VALUES</span>(</span><br><span class="line">   <span class="keyword">unhex</span>(<span class="keyword">replace</span>(<span class="keyword">uuid</span>(), <span class="string">'-'</span>, <span class="string">''</span>))</span><br><span class="line">   , <span class="string">"car"</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>查询UUID</strong></p>
<ul>
<li>使用hex()函数转换UUID到十六进制字符表示。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">id</span>, <span class="keyword">name</span> <span class="keyword">FROM</span> product;</span><br><span class="line"><span class="comment">/* BLOB, 'car' */</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">hex</span>(<span class="keyword">id</span>), <span class="keyword">name</span> <span class="keyword">FROM</span> product;</span><br><span class="line"><span class="comment">/* 'BFF641BA9F3A4584A1BA53824E7AB3B9', 'car' */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 通过特定UUID进行指定Row数据查询 */</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">hex</span>(<span class="keyword">id</span>), <span class="keyword">name</span> <span class="keyword">FROM</span> product</span><br><span class="line">   <span class="keyword">WHERE</span> <span class="keyword">id</span> = <span class="keyword">unhex</span>(<span class="string">'BFF641BA9F3A4584A1BA53824E7AB3B9'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* or if you have a UUID with dashes: */</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">hex</span>(<span class="keyword">id</span>), <span class="keyword">name</span> <span class="keyword">FROM</span> product</span><br><span class="line">   <span class="keyword">WHERE</span> <span class="keyword">id</span> = <span class="keyword">unhex</span>(<span class="keyword">replace</span>(<span class="string">"2b08e375-275d-473e-910d-32700e34b61a"</span>, <span class="string">'-'</span>, <span class="string">''</span>));</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>小结</strong></p>
<ul>
<li>在工程的角度，使用UUID作为Model的主键，应该是利大于弊；</li>
<li>使用<code>BINARY(16)</code>存储，性能损耗在可接受范围；</li>
<li>对于SQL层面操作的不便，个人认为可以忍受(不过不同DB操作语言可能会有差异)。</li>
</ul>
</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://dragonetail.github.io/2019/05/31/Flutter与vscode分析异常错误处理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黑哈">
      <meta itemprop="description" content="~黑哈等你回家~">
      <meta itemprop="image" content="/images/blackharry1.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="微笑卡卡西">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/05/31/Flutter与vscode分析异常错误处理/" class="post-title-link" itemprop="url">Flutter与vscode分析异常错误处理</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-05-31 00:05:49 / 修改时间：00:53:46" itemprop="dateCreated datePublished" datetime="2019-05-31T00:05:49+08:00">2019-05-31</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Flutter/" itemprop="url" rel="index"><span itemprop="name">Flutter</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Flutter/VSCode/" itemprop="url" rel="index"><span itemprop="name">VSCode</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Flutter与vscode分析异常错误处理"><a href="#Flutter与vscode分析异常错误处理" class="headerlink" title="Flutter与vscode分析异常错误处理"></a>Flutter与vscode分析异常错误处理</h1><p>使用Flutter和VSCode开发一段时间，之前一直使用<a href="https://storage.googleapis.com/flutter_infra/releases/stable/macos/flutter_macos_v1.2.1-stable.zip" target="_blank" rel="noopener">v1.2.1</a>进行开发，配合XCode调试ios代码，Android Studio调试安卓代码，一直相安无事，最近升级到<a href="https://storage.googleapis.com/flutter_infra/releases/stable/macos/flutter_macos_v1.5.4-hotfix.2-stable.zip" target="_blank" rel="noopener">v1.5.4-hotfix.2</a>之后，遇到奇怪的现象，一周多没有解决，今天总算解决了，记录一下。</p>
<p>1、问题现象：</p>
<p>在<a href="https://storage.googleapis.com/flutter_infra/releases/stable/macos/flutter_macos_v1.5.4-hotfix.2-stable.zip" target="_blank" rel="noopener">v1.5.4-hotfix.2</a>下面，发现pubspec.yaml中定义的dependencies都正常通过flutter packages get能够下载，并且运行flutter run或者直接在vscode中运行APP都没有问题。</p>
<p>但是在vscode中，依赖的一些package在import的时候会出现红色错误提示（Target of URI doesn’t exist: ），对应class引用也会有错误提示（The method ‘xxxx’ isn’t defined for the class）。</p>
<p>实质上上面的import和引用都没有问题。</p>
<p>2、经过观察，和网上调查，都说packages get然后重启vscode可以解决，实际并没有。</p>
<p>但是通过重启vscode，发现刚刚打开工程的时候，在状态栏中提示【Analyzing】很快就结束了，不太正常。</p>
<p>观察vscode状态栏右边的警铃标记位【1】，点击能够看到错误信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exception from the Dart analysis server: FileSystemException(path=/Users/user/workspace/ios/flutter_test/example/ios/.symlinks/plugins/flutter_test/example/ios/.symlinks/plugins/flutter_test/example/ios/.symlinks/plugins/flutter_test/example/ios/.symlinks/plugins/flutter_test/example/ios/.symlinks/plugins/flutter_test/example/ios/.symlinks/plugins/flutter_test/example/ios/.symlinks/plugins/flutter_test/example/ios/.symlinks/plugins/flutter_test/example/ios/.symlinks/plugins/flutter_test/example/ios/.symlinks/plugins/flutter_test/example/ios/.symlinks/plugins/flutter_test/example/ios/.symlinks/plugins/flutter_test/example/ios/.symlinks/plugins/flutter_test/example/ios/.symlinks/plugins/flutter_test/example/ios/.symlinks/plugins/flutter_test/example/ios/.symlinks/plugins/flutter_test/exampl...</span><br></pre></td></tr></table></figure>
<p>3、对于上面的错误，网上google，各种尝试，都没有解决。</p>
<p>重装了vscode、重装flutter、删除所有的flutter和dart以及pub的缓存，都没有解决。</p>
<p>无奈之下，重新降级flutter版本回到<a href="https://storage.googleapis.com/flutter_infra/releases/stable/macos/flutter_macos_v1.2.1-stable.zip" target="_blank" rel="noopener">v1.2.1</a>，发现问题解决，但是不少使用的依赖库已经更新到dart的2.2.0版本，必须手工处理太多plugin的版本兼容问题。</p>
<p>最终还是决定在执行flutter upgrade到<a href="https://storage.googleapis.com/flutter_infra/releases/stable/macos/flutter_macos_v1.5.4-hotfix.2-stable.zip" target="_blank" rel="noopener">v1.5.4-hotfix.2</a>，但是升级之后，问题依旧，因此应该跟系统环境没有关系。</p>
<p>4、详细观察了一下警铃标记提示的错误信息，发现是跟ios的pod依赖产生的【.symlinks】目录有关，这个目录是之前通过xcode调试ios代码的时候遗留的，之前没有问题，可能flutter升级之后依赖有问题。</p>
<p>5、尝试删除【.symlinks】之后，重启vscode，发现之前不能正常工作的【Analyzing】恢复了正常。</p>
<p>6、选在IPhone模拟器，运行测试之后，发现在【example/ios】目录中又出现了【.symlinks】目录，xcode打开Runner工程，也能够在Pods依赖中发现对应功能。</p>
<p>这个问题应该只是在对plugin的example功能测试的时候会发生这种情况，也应该是跟<a href="https://storage.googleapis.com/flutter_infra/releases/stable/macos/flutter_macos_v1.5.4-hotfix.2-stable.zip" target="_blank" rel="noopener">v1.5.4-hotfix.2</a>版本问题，不过不影响大局，测试ios之后及时手工删除【.symlinks】目录基本不影响工作了。</p>
<p>7、问题已经报告到flutter的Issue列表： <a href="https://github.com/flutter/flutter/issues/33592" target="_blank" rel="noopener">https://github.com/flutter/flutter/issues/33592</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://dragonetail.github.io/2019/04/19/Flutter和Dart的异步编程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黑哈">
      <meta itemprop="description" content="~黑哈等你回家~">
      <meta itemprop="image" content="/images/blackharry1.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="微笑卡卡西">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/19/Flutter和Dart的异步编程/" class="post-title-link" itemprop="url">Flutter和Dart的异步编程</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-04-19 13:09:35 / 修改时间：22:37:46" itemprop="dateCreated datePublished" datetime="2019-04-19T13:09:35+08:00">2019-04-19</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/APP编程/" itemprop="url" rel="index"><span itemprop="name">APP编程</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Flutter和Dart的异步编程"><a href="#Flutter和Dart的异步编程" class="headerlink" title="Flutter和Dart的异步编程"></a>Flutter和Dart的异步编程</h1><p>参考：</p>
<ul>
<li><a href="https://medium.com/@takahirom/how-to-write-flutter-asynchronous-processing-22f845204f30" target="_blank" rel="noopener">https://medium.com/@takahirom/how-to-write-flutter-asynchronous-processing-22f845204f30</a></li>
<li><a href="https://www.youtube.com/watch?v=MUDOIAssBDs&amp;feature=youtu.be" target="_blank" rel="noopener">https://www.youtube.com/watch?v=MUDOIAssBDs&amp;feature=youtu.be</a></li>
</ul>
<p>使用Flutter和Dart开发APP或者应用时，通常需要访问DB、API、或其他资源，都需要异步处理进行性能提升。</p>
<p>作为Flutter开发组件库，提供了两个组件直接支持异步的UI构建处理（<a href="https://flutter.io/widgets/async/）。" target="_blank" rel="noopener">https://flutter.io/widgets/async/）。</a></p>
<ul>
<li>FutureBuilder： 基于Future的最新数据来构建Widget。</li>
<li>StreamBuilder： 基于数据流Stream的数据来构建Widget（可以支持多个数据持续更新构建，BLOC的架构就是依次模式构建）。</li>
</ul>
<h2 id="Dart-Asynchronous-基础"><a href="#Dart-Asynchronous-基础" class="headerlink" title="Dart Asynchronous 基础"></a>Dart Asynchronous 基础</h2><p>Future表示一个数据还没有存在：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Future</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  Future&lt;R&gt; then&lt;R&gt;(FutureOr&lt;R&gt; onValue(T value), &#123;<span class="built_in">Function</span> onError&#125;);</span><br><span class="line">  Future&lt;T&gt; catchError(<span class="built_in">Function</span> onError, &#123;<span class="built_in">bool</span> test(<span class="built_in">Object</span> error)&#125;);</span><br><span class="line">  Future&lt;T&gt; whenComplete(FutureOr action());</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Stream标识一个异步的迭代对象，有顺序数据、可以操作和过滤数据；迭代是拉（Pull）模式访问数据，Stream是推（Push）模式访问数据。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Stream</span>&lt;<span class="title">E</span>&gt;</span>&#123;</span><br><span class="line">    listen(<span class="keyword">void</span> onData(E data), ...);</span><br><span class="line">    </span><br><span class="line">    Stream map(<span class="built_in">Function</span> f);</span><br><span class="line">    Stream&lt;E&gt; where(<span class="built_in">Function</span> f);</span><br><span class="line">    Future&lt;E&gt; <span class="keyword">get</span> first;</span><br><span class="line">    <span class="keyword">void</span> forEach(<span class="keyword">void</span> f(E element));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Stream &amp; Future例子：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">runServer()&#123;</span><br><span class="line">    <span class="keyword">var</span> future = HttpServer.bind(<span class="string">'127.0.0.1'</span>, <span class="number">4040</span>);</span><br><span class="line">    future.then((HttpServer server)&#123;  <span class="comment">// a Stream</span></span><br><span class="line">    	server.listen((HttpRequest request)&#123;</span><br><span class="line">           request.reponse.write(<span class="string">'Hello, world!'</span>);</span><br><span class="line">           request.response.close();</span><br><span class="line">    	&#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>问题是使用了太多的Callback级联，通过使用await语法糖可以简化，清晰逻辑。</p>
<p>过渡方案，使用for循环优化例子：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">runServer()&#123;</span><br><span class="line">    <span class="keyword">var</span> server = HttpServer.bind(<span class="string">'127.0.0.1'</span>, <span class="number">4040</span>);</span><br><span class="line">    <span class="keyword">for</span> (HttpRequest request <span class="keyword">in</span> server.requests) &#123; </span><br><span class="line">       request.reponse.write(<span class="string">'Hello, world!'</span>);</span><br><span class="line">       request.response.close();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>await优化的例子：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">runServer() <span class="keyword">async</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> server = <span class="keyword">await</span> HttpServer.bind(<span class="string">'127.0.0.1'</span>, <span class="number">4040</span>);</span><br><span class="line">    server.listen((HttpRequest request)&#123;</span><br><span class="line">        request.reponse.write(<span class="string">'Hello, world!'</span>);</span><br><span class="line">        request.response.close();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>await for继续优化：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">runServer() <span class="keyword">async</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> server = <span class="keyword">await</span> HttpServer.bind(<span class="string">'127.0.0.1'</span>, <span class="number">4040</span>);</span><br><span class="line">    <span class="keyword">await</span> <span class="keyword">for</span> (HttpRequest request <span class="keyword">in</span> server.requests) &#123;</span><br><span class="line">        request.reponse.write(<span class="string">'Hello, world!'</span>);</span><br><span class="line">        request.response.close();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于Await的用法，对于Future进行等待期执行结果，在代码块（方法）内，await把Future的异步处理变成了同步调用关系（Process）；同时await返回Future的泛型结果数据。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">API:</span><br><span class="line">	Future&lt;<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt;&gt; File.readAsLines();</span><br><span class="line">Async use:</span><br><span class="line">	<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; lines = <span class="keyword">await</span> file.readAsLines();</span><br></pre></td></tr></table></figure>
<p>await也可以使用在非Future对象上的任意变量上，等价于Future的value包装。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="number">998</span>;</span><br><span class="line">    ==</span><br><span class="line"><span class="keyword">await</span> <span class="keyword">new</span> Future.value(<span class="number">988</span>);</span><br></pre></td></tr></table></figure>
<p>闭包的使用：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">foo(() <span class="keyword">async</span> =&gt; ...);</span><br><span class="line">foo(() <span class="keyword">async</span> &#123;...&#125;);</span><br></pre></td></tr></table></figure>
<p>Bodywrap与microtask：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Future runServer() <span class="keyword">async</span> &#123;...&#125;</span><br><span class="line">  ==</span><br><span class="line">Future runServer() =&gt; <span class="keyword">new</span> Future.miscrotask(()&#123;...&#125;);</span><br></pre></td></tr></table></figure>
<p>Bodywrap的运行结果和影响（Consequences）：</p>
<ul>
<li>在代码块中的错误会被自行捕获，并返回到Future中；</li>
<li>Functions yield at entry (???)</li>
<li>返回的Futures可以被链条处理（chained）；</li>
<li>返回结果是Future类型</li>
</ul>
<p>异步返回多个数据，需要使用Stream，一个数据的时候使用Future。同步的时候使用Iterable返回多个数据。</p>
<p>同步多个数据迭代处理（Iterable &amp; sync*）：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Iterable</span> range(<span class="built_in">int</span> from, <span class="built_in">int</span> to) <span class="keyword">sync</span>* &#123;</span><br><span class="line">    <span class="keyword">for</span> (init i = from; i &lt; to; i++) &#123;</span><br><span class="line">        <span class="keyword">yield</span> i;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">range(<span class="number">3</span>, <span class="number">6</span>).forEach(<span class="built_in">print</span>);  <span class="comment">//Prints 3 4 5</span></span><br></pre></td></tr></table></figure>
<p>yield推送一个数据，yeild*在另外一个迭代之间建立管道，推送数据到上层迭代。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Iterable</span> recRange(<span class="built_in">int</span> from, <span class="built_in">int</span> to)&#123;</span><br><span class="line">    <span class="keyword">if</span> (from &lt; to)&#123;</span><br><span class="line">        <span class="keyword">yield</span> from;</span><br><span class="line">        <span class="keyword">yield</span>* recRange(from + <span class="number">1</span>, to);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>异步返回多个数据到Streams中，使用async*:</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Stream bigFiles(<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; fileNames) <span class="keyword">async</span>* &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> fileName <span class="keyword">in</span> fileNames) &#123;</span><br><span class="line">        <span class="keyword">var</span> stat = <span class="keyword">await</span> <span class="keyword">new</span> File(fileName).stat();</span><br><span class="line">        <span class="keyword">if</span> (stat.size &gt; <span class="number">100000</span>) <span class="keyword">yield</span> fileName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Async*的内部细节：</p>
<ul>
<li>函数直到listen方法调用的时候才会开始执行；</li>
<li>cancel方法可以终结async函数；</li>
<li>Yield通过event loop返回数据。</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="keyword">true</span>) &#123; <span class="keyword">yield</span> <span class="number">988</span> &#125;</span><br></pre></td></tr></table></figure>
<p>异步编程的问题：</p>
<ul>
<li>Debug调试困难<ul>
<li>处理交错执行</li>
<li>堆栈帧丢失</li>
</ul>
</li>
<li>当Debug时，stacktrace有太多的Noice，解决办法，使用stack_trace包简化调用处理：</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:stack_trace/stack_trace.dart'</span>;</span><br><span class="line"></span><br><span class="line">foo() <span class="keyword">async</span>&#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="string">'asynchronous wait'</span>;</span><br><span class="line">    <span class="keyword">throw</span> <span class="string">'error'</span>;</span><br><span class="line">&#125;</span><br><span class="line">bar() =&gt; foo();</span><br><span class="line">gee() =&gt; bar();</span><br><span class="line">main()&#123;</span><br><span class="line">    Chain.capture(gee, onError: (e, chain)&#123;</span><br><span class="line">        <span class="built_in">print</span>(chain.terse);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Dart-Asynchronous-Processing"><a href="#Dart-Asynchronous-Processing" class="headerlink" title="Dart Asynchronous Processing"></a>Dart Asynchronous Processing</h2><p>Dart语言支持异步处理流程，通常的用法有如下7种模式。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'dart:async'</span>;</span><br><span class="line"></span><br><span class="line">main() <span class="keyword">async</span>&#123;</span><br><span class="line">  <span class="comment">// ① 使用Future和Then级联同步调用</span></span><br><span class="line">  asyncFunc1().then((_) =&gt; asyncFunc2()).then((result) &#123;</span><br><span class="line">    <span class="built_in">print</span>(result);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ② 使用await同步调用两个异步方法</span></span><br><span class="line">  <span class="keyword">var</span> asyncResult1 = <span class="keyword">await</span> asyncFunc1();</span><br><span class="line">  <span class="keyword">var</span> asyncResult2 = <span class="keyword">await</span> asyncFunc2();</span><br><span class="line">  <span class="built_in">print</span>(asyncResult2);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ③ 使用await Future.wait同步等待两个异步调用并发执行结束</span></span><br><span class="line">  <span class="keyword">var</span> list = <span class="keyword">await</span> Future.wait([asyncFunc1(), asyncFunc2()]);</span><br><span class="line">  <span class="built_in">print</span>(list[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ④ 把Future转换成Stream模式调用</span></span><br><span class="line">  asyncFunc1().asStream().asyncMap((_) =&gt; asyncFunc2()).listen((result) &#123;</span><br><span class="line">    <span class="built_in">print</span>(result);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ⑤ 把Future转换成Stream，然后使用await for循环Stream的结果同步处理</span></span><br><span class="line">  <span class="keyword">var</span> stream = asyncFunc1().asStream().asyncMap((_) =&gt; asyncFunc2());</span><br><span class="line">  <span class="keyword">await</span> <span class="keyword">for</span> (<span class="keyword">var</span> result <span class="keyword">in</span> stream) &#123;</span><br><span class="line">    <span class="built_in">print</span>(result);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ⑥ 把Future转换成Stram模式调用</span></span><br><span class="line">  asyncFunc1()</span><br><span class="line">      .asStream()</span><br><span class="line">      .asyncExpand((_) =&gt; asyncFunc2().asStream())</span><br><span class="line">      .listen((result) &#123;</span><br><span class="line">    <span class="built_in">print</span>(result);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ⑦ 把Future转换成Stream并用yield方式级联</span></span><br><span class="line">  asyncFunc1().asStream().asyncExpand((_) <span class="keyword">async</span>* &#123;</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">await</span> asyncFunc2();</span><br><span class="line">  &#125;).listen((result) &#123;</span><br><span class="line">    <span class="built_in">print</span>(result);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Future&lt;<span class="built_in">String</span>&gt; asyncFunc1() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"async return1"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Future&lt;<span class="built_in">String</span>&gt; asyncFunc2() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"async return2"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于什么时候使用Future，什么时候使用Stream。</p>
<p>对于多个数据的异步处理流程，只能使用Stream，对于一般异步处理使用Future和Then更加有利于代码逻辑组织。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;<span class="built_in">String</span>&gt; asyncFunc() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"async return"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> asyncResult = <span class="keyword">await</span> asyncFunc();</span><br><span class="line"><span class="built_in">print</span>(asyncResult);</span><br><span class="line"><span class="comment">// vs</span></span><br><span class="line">Stream&lt;<span class="built_in">String</span>&gt; streamFunc() <span class="keyword">async</span>* &#123;</span><br><span class="line">  <span class="keyword">yield</span> <span class="string">"stream return"</span>;</span><br><span class="line">&#125;</span><br><span class="line">streamFunc().listen((result) &#123;</span><br><span class="line">  <span class="built_in">print</span>(result);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><strong>This allows you to choose whether to use FutureBuilder or StreamBuilder depending on your situation</strong>.</p>
<h3 id="“await-for”-和-“listen-”"><a href="#“await-for”-和-“listen-”" class="headerlink" title="“await for” 和 “listen()”"></a><strong>“await for”</strong> 和 “<strong>listen()”</strong></h3><p>在大多数场景，使用 <strong>wait for</strong>会应该更清晰表达逻辑。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'dart:async'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'dart:io'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'dart:math'</span>;</span><br><span class="line"></span><br><span class="line">main() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="keyword">for</span> (<span class="keyword">var</span> tick <span class="keyword">in</span> endlessCountDown()) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"coutDown <span class="subst">$tick</span>"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//  endlessCountDown().listen((tick) &#123;</span></span><br><span class="line"><span class="comment">//    print("coutDown $tick");</span></span><br><span class="line"><span class="comment">//  &#125;);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Stream&lt;<span class="built_in">int</span>&gt; endlessCountDown() <span class="keyword">async</span>* &#123;</span><br><span class="line">  <span class="keyword">var</span> i = pow(<span class="number">2</span>, <span class="number">30</span>) - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    sleep(<span class="keyword">new</span> <span class="built_in">Duration</span>(seconds: <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">yield</span> i--;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是使用await和listen还是有区别，一个是同步流程，一个是异步流程。例如下面这个例子，使用await，后一个<code>countUp</code>永远也不会被执行到。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'dart:async'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'dart:io'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'dart:math'</span>;</span><br><span class="line"></span><br><span class="line">main() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="keyword">for</span> (<span class="keyword">var</span> tick <span class="keyword">in</span> endlessCountDown()) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"coutDown <span class="subst">$tick</span>"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">await</span> <span class="keyword">for</span> (<span class="keyword">var</span> line <span class="keyword">in</span> endlessCountUp()) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"countUp <span class="subst">$line</span>"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Stream&lt;<span class="built_in">int</span>&gt; endlessCountUp() <span class="keyword">async</span>* &#123;</span><br><span class="line">  <span class="keyword">var</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    sleep(<span class="keyword">new</span> <span class="built_in">Duration</span>(seconds: <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">yield</span> i++;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Stream&lt;<span class="built_in">int</span>&gt; endlessCountDown() <span class="keyword">async</span>* &#123;</span><br><span class="line">  <span class="keyword">var</span> i = pow(<span class="number">2</span>, <span class="number">30</span>) - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    sleep(<span class="keyword">new</span> <span class="built_in">Duration</span>(seconds: <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">yield</span> i--;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然，单独的处理封装成异步方法，再调用，就可以把await的操作又异步化组合一起了，但是有这个必要吗？这个时候也许使用listen更好一下吧，具体看情况而定。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'dart:async'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'dart:io'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'dart:math'</span>;</span><br><span class="line"></span><br><span class="line">main() &#123;</span><br><span class="line">  listenCountDown();</span><br><span class="line">  listenCountUp();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">listenCountDown() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="keyword">for</span> (<span class="keyword">var</span> tick <span class="keyword">in</span> endlessCountDown()) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"coutDown <span class="subst">$tick</span>"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">listenCountUp() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="keyword">for</span> (<span class="keyword">var</span> tick <span class="keyword">in</span> endlessCountUp()) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"coutUp <span class="subst">$tick</span>"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>这是用listen的例子，是不是在这种状况下会更好一些。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import &apos;dart:async&apos;;</span><br><span class="line">import &apos;dart:io&apos;;</span><br><span class="line">import &apos;dart:math&apos;;</span><br><span class="line"></span><br><span class="line">main() &#123;</span><br><span class="line">  endlessCountDown().listen((tick) &#123;</span><br><span class="line">    print(&quot;coutDown $tick&quot;);</span><br><span class="line">  &#125;);</span><br><span class="line">  endlessCountUp().listen((tick) &#123;</span><br><span class="line">    print(&quot;coutUp $tick&quot;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong> 在Stream上使用<code>await for</code>的时候，一定要清晰认识到你是否需要等待所有的Stream数据都到达处理完后再执行后续操作。这个在很多场合都是不适用的，例如侦听Dom的事件，如果对Dom两个节点进行侦听事件的处理，就不能适用<code>await for</code>，而应该使用<code>listen</code>异步侦听模式。</p>
<p>简单的说，<code>await for</code>是同步拆解出所有的stream数据并处理，在特定场景需要这样做，另外一些场景缺不能这样做。</p>
<h3 id="“await”-、-“then-”-和-“await-Future-wait-”"><a href="#“await”-、-“then-”-和-“await-Future-wait-”" class="headerlink" title="“await” 、 “then()” 和 “await Future.wait()”"></a>“await” 、 “then()” 和 “await Future.wait()”</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ① 使用Future和Then级联同步调用</span></span><br><span class="line">asyncFunc1().then((_) =&gt; asyncFunc2()).then((result) &#123;</span><br><span class="line">  <span class="built_in">print</span>(result);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ② 使用await同步调用两个异步方法</span></span><br><span class="line"><span class="keyword">var</span> asyncResult1 = <span class="keyword">await</span> asyncFunc1();</span><br><span class="line"><span class="keyword">var</span> asyncResult2 = <span class="keyword">await</span> asyncFunc2();</span><br><span class="line"><span class="built_in">print</span>(asyncResult2);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ③ 使用await Future.wait同步等待两个异步调用并发执行结束</span></span><br><span class="line"><span class="keyword">var</span> list = <span class="keyword">await</span> Future.wait([asyncFunc1(), asyncFunc2()]);</span><br><span class="line"><span class="built_in">print</span>(list[<span class="number">1</span>]);</span><br></pre></td></tr></table></figure>
<p>同上，<code>await</code>是同步等待数据并执行，<code>then</code>是异步侦听模式；而<code>await Future.wait()</code>是多个异步并发执行，并等待所有异步操作执行返回。</p>
<p>下面使用Stopwatch来比较各个处理流程需要的时间。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ②</span></span><br><span class="line"><span class="built_in">Stopwatch</span> stopwatch1 = <span class="keyword">new</span> <span class="built_in">Stopwatch</span>()..start();</span><br><span class="line"><span class="keyword">var</span> asyncResult1 = <span class="keyword">await</span> asyncFunc1();</span><br><span class="line"><span class="keyword">var</span> asyncResult2 = <span class="keyword">await</span> asyncFunc2();</span><br><span class="line"><span class="built_in">print</span>(asyncResult2);</span><br><span class="line"><span class="built_in">print</span>(<span class="string">'await() executed in <span class="subst">$&#123;stopwatch1.elapsed&#125;</span>'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ③</span></span><br><span class="line"><span class="built_in">Stopwatch</span> stopwatch2 = <span class="keyword">new</span> <span class="built_in">Stopwatch</span>()..start();</span><br><span class="line"><span class="keyword">var</span> list = <span class="keyword">await</span> Future.wait([asyncFunc1(), asyncFunc2()]);</span><br><span class="line"><span class="built_in">print</span>(list[<span class="number">1</span>]);</span><br><span class="line"><span class="built_in">print</span>(<span class="string">'Future.wait() executed in <span class="subst">$&#123;stopwatch2.elapsed&#125;</span>'</span>);</span><br><span class="line"></span><br><span class="line">Future&lt;<span class="built_in">String</span>&gt; asyncFunc1() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Future.delayed(<span class="keyword">const</span> <span class="built_in">Duration</span>(seconds: <span class="number">1</span>), () =&gt; <span class="string">"async return1"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Future&lt;<span class="built_in">String</span>&gt; asyncFunc2() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Future.delayed(<span class="keyword">const</span> <span class="built_in">Duration</span>(seconds: <span class="number">1</span>), () =&gt; <span class="string">"async return2"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据以上的例子，②用的时间为2秒多些，③用的时间为1秒多些，③更好的并行使用了线程的时间。</p>
<p>因此如果业务场景适合，使用Future.wait会有更好的性能输出。</p>
<h3 id="最后，一个例子展示如何使用FutureBuilder"><a href="#最后，一个例子展示如何使用FutureBuilder" class="headerlink" title="最后，一个例子展示如何使用FutureBuilder"></a><strong>最后，一个例子展示如何使用</strong>FutureBuilder</h3><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'dart:async'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'dart:convert'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter/material.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:github_flutter/access_token.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:github_flutter/model/event.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:github_flutter/model/user.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:http/http.dart'</span> <span class="keyword">as</span> http;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main() =&gt; runApp(<span class="keyword">new</span> MyApp());</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MaterialApp(</span><br><span class="line">      title: <span class="string">'Flutter Demo'</span>,</span><br><span class="line">      theme: <span class="keyword">new</span> ThemeData(</span><br><span class="line">        primarySwatch: Colors.deepPurple,</span><br><span class="line">      ),</span><br><span class="line">      home: <span class="keyword">new</span> FutureBuilder(future: <span class="keyword">new</span> Future(() <span class="keyword">async</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> token = <span class="keyword">await</span> AccessToken.getInstance().getOrCreate();</span><br><span class="line">        <span class="keyword">var</span> user = <span class="keyword">await</span> fetchUser(token);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> fetchEvents(user, token);</span><br><span class="line">      &#125;), builder: (BuildContext context, AsyncSnapshot&lt;EventList&gt; feedState) &#123;</span><br><span class="line">        <span class="keyword">if</span> (feedState.error != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// <span class="doctag">TODO:</span> error handling</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (feedState.data == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> Center(child: <span class="keyword">new</span> CircularProgressIndicator());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyHomePage(title: <span class="string">'GitHub Events'</span>, events: feedState.data);</span><br><span class="line">      &#125;),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future&lt;User&gt; fetchUser(<span class="built_in">String</span> token) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> userResponse =</span><br><span class="line">        <span class="keyword">await</span> http.<span class="keyword">get</span>(<span class="string">'https://api.github.com/user?access_token='</span> + token);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> User.fromJson(json.decode(userResponse.body));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future&lt;EventList&gt; fetchEvents(User user, <span class="built_in">String</span> token) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> response = <span class="keyword">await</span> http.<span class="keyword">get</span>(<span class="string">'https://api.github.com/users/<span class="subst">$&#123;user</span></span></span><br><span class="line"><span class="string"><span class="subst">        .login&#125;</span>/events?access_token='</span> +</span><br><span class="line">        token);</span><br><span class="line">    <span class="built_in">print</span>(response.body);</span><br><span class="line">    <span class="keyword">final</span> responseJson = json.decode(response.body);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> EventList.fromJson(responseJson);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyHomePage</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  MyHomePage(&#123;Key key, <span class="keyword">this</span>.title, <span class="keyword">this</span>.events&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> title;</span><br><span class="line">  <span class="keyword">final</span> EventList events;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _MyHomePageState createState() =&gt; <span class="keyword">new</span> _MyHomePageState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_MyHomePageState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">MyHomePage</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">void</span> _incrementCounter() &#123;</span><br><span class="line">    setState(() &#123;&#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">var</span> notifiationList = widget.events.events;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Scaffold(</span><br><span class="line">        appBar: <span class="keyword">new</span> AppBar(</span><br><span class="line">          title: <span class="keyword">new</span> Text(widget.title),</span><br><span class="line">        ),</span><br><span class="line">        body: <span class="keyword">new</span> ListView.builder(</span><br><span class="line">            itemCount: notifiationList.length,</span><br><span class="line">            itemBuilder: (context, index) &#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">new</span> ListTile(</span><br><span class="line">                onTap: _launchURL(notifiationList[index]</span><br><span class="line">                    .url</span><br><span class="line">                    .replaceFirst(<span class="string">"api.github.com/repos"</span>, <span class="string">"github.com"</span>)),</span><br><span class="line">                title: <span class="keyword">new</span> Text(<span class="string">'<span class="subst">$&#123;notifiationList[index]</span></span></span><br><span class="line"><span class="string"><span class="subst">                    .repoFullName&#125;</span> : <span class="subst">$&#123;notifiationList[index].type&#125;</span>'</span>),</span><br><span class="line">              );</span><br><span class="line">            &#125;),</span><br><span class="line">        floatingActionButton: <span class="keyword">new</span> FloatingActionButton(</span><br><span class="line">          onPressed: _incrementCounter,</span><br><span class="line">          tooltip: <span class="string">'Increment'</span>,</span><br><span class="line">          child: <span class="keyword">new</span> Icon(Icons.add),</span><br><span class="line">        ));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  _launchURL(<span class="built_in">String</span> url) &#123;</span><br><span class="line">    <span class="keyword">return</span> () <span class="keyword">async</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">await</span> canLaunch(url)) &#123;</span><br><span class="line">        <span class="keyword">await</span> launch(url);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="string">'Could not launch <span class="subst">$url</span>'</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://dragonetail.github.io/2019/04/18/Flutter的Bloc工程化系列3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黑哈">
      <meta itemprop="description" content="~黑哈等你回家~">
      <meta itemprop="image" content="/images/blackharry1.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="微笑卡卡西">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/18/Flutter的Bloc工程化系列3/" class="post-title-link" itemprop="url">Flutter的Bloc工程化系列3</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-04-18 22:09:35" itemprop="dateCreated datePublished" datetime="2019-04-18T22:09:35+08:00">2019-04-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-04-19 11:50:53" itemprop="dateModified" datetime="2019-04-19T11:50:53+08:00">2019-04-19</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/APP编程/" itemprop="url" rel="index"><span itemprop="name">APP编程</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="APP启动页（Splash-Page）"><a href="#APP启动页（Splash-Page）" class="headerlink" title="APP启动页（Splash Page）"></a>APP启动页（Splash Page）</h1><p><strong>说明：</strong> 本部分完成部分在分支： <a href="https://github.com/dragonetail/flutterpoc/tree/3-splash_page" target="_blank" rel="noopener">https://github.com/dragonetail/flutterpoc/tree/3-splash_page</a></p>
<p><strong>目标：</strong> 涉及Flutter的Router和Splash Page工作原理，全程使用Bloc模式。</p>
<p><strong>思路：</strong> </p>
<ul>
<li>使用Model定义Splash过程所涉及的数据，引导页、广告页、同服务器交互更新图片所有的数据Model。</li>
<li>存储数据Splash所用数据到SP（shared_preferences）中。</li>
<li>提供HTTP API通过后端Rest更新Splash显示所用图片和标题，控制显示动作。</li>
<li>抽象Service提供对SP和HTTP数据的访问封装。</li>
<li>定义Bloc，根据SP中获取的数据进行视图Builder构建，包括默认数据行为设置。</li>
<li>实现Page页面；</li>
<li>通过Common封装实现引导页、广告页的View。</li>
</ul>
<ol>
<li><p>Model数据：</p>
<p>引导页数据模型。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SplashGuideModel</span> </span>&#123;</span><br><span class="line">  <span class="built_in">bool</span> isUrl;</span><br><span class="line">  <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; images;</span><br><span class="line">  <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; textInfos;</span><br><span class="line"></span><br><span class="line">  SplashGuideModel(&#123;<span class="keyword">this</span>.isUrl, <span class="keyword">this</span>.images, <span class="keyword">this</span>.textInfos&#125;);</span><br><span class="line"></span><br><span class="line">  SplashGuideModel.fromJson(<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt; json)</span><br><span class="line">      : isUrl = json[<span class="string">'isUrl'</span>],</span><br><span class="line">        images = json[<span class="string">'images'</span>].cast&lt;<span class="built_in">String</span>&gt;(),</span><br><span class="line">        textInfos = json[<span class="string">'textInfos'</span>].cast&lt;<span class="built_in">String</span>&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt; toJson() =&gt; &#123;</span><br><span class="line">        <span class="string">'tiisUrltle'</span>: isUrl,</span><br><span class="line">        <span class="string">'images'</span>: images,</span><br><span class="line">        <span class="string">'textInfos'</span>: textInfos,</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">String</span> toString() &#123;</span><br><span class="line">    <span class="built_in">StringBuffer</span> sb = <span class="keyword">new</span> <span class="built_in">StringBuffer</span>(<span class="string">'&#123;'</span>);</span><br><span class="line">    sb.write(<span class="string">"\"isUrl\":\"<span class="subst">$isUrl</span>\""</span>);</span><br><span class="line">    sb.write(<span class="string">",\"images\":\"<span class="subst">$images</span>\""</span>);</span><br><span class="line">    sb.write(<span class="string">",\"textInfos\":\"<span class="subst">$textInfos</span>\""</span>);</span><br><span class="line">    sb.write(<span class="string">'&#125;'</span>);</span><br><span class="line">    <span class="keyword">return</span> sb.toString();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>广告页数据模型：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SplashAdModel</span> </span>&#123;</span><br><span class="line">  <span class="built_in">String</span> title;</span><br><span class="line">  <span class="built_in">String</span> imageUrl;</span><br><span class="line">  <span class="built_in">String</span> targetUrl;</span><br><span class="line"></span><br><span class="line">  SplashAdModel(&#123;<span class="keyword">this</span>.title, <span class="keyword">this</span>.imageUrl, <span class="keyword">this</span>.targetUrl&#125;);</span><br><span class="line"></span><br><span class="line">  SplashAdModel.fromJson(<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt; json)</span><br><span class="line">      : title = json[<span class="string">'title'</span>],</span><br><span class="line">        imageUrl = json[<span class="string">'imageUrl'</span>],</span><br><span class="line">        targetUrl = json[<span class="string">'targetUrl'</span>];</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt; toJson() =&gt; &#123;</span><br><span class="line">        <span class="string">'title'</span>: title,</span><br><span class="line">        <span class="string">'imageUrl'</span>: imageUrl,</span><br><span class="line">        <span class="string">'targetUrl'</span>: targetUrl,</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">String</span> toString() &#123;</span><br><span class="line">    <span class="built_in">StringBuffer</span> sb = <span class="keyword">new</span> <span class="built_in">StringBuffer</span>(<span class="string">'&#123;'</span>);</span><br><span class="line">    sb.write(<span class="string">"\"title\":\"<span class="subst">$title</span>\""</span>);</span><br><span class="line">    sb.write(<span class="string">",\"imageUrl\":\"<span class="subst">$imageUrl</span>\""</span>);</span><br><span class="line">    sb.write(<span class="string">",\"targetUrl\":\"<span class="subst">$targetUrl</span>\""</span>);</span><br><span class="line">    sb.write(<span class="string">'&#125;'</span>);</span><br><span class="line">    <span class="keyword">return</span> sb.toString();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>网络通信用的数据模型：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'./index.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SplashModel</span> </span>&#123;</span><br><span class="line">  <span class="built_in">String</span> version;</span><br><span class="line">  <span class="built_in">bool</span> nextShowGuide;</span><br><span class="line">  <span class="built_in">bool</span> updateGuideInfo;</span><br><span class="line">  <span class="built_in">bool</span> updateAdInfo;</span><br><span class="line">  SplashGuideModel guideInfo;</span><br><span class="line">  SplashAdModel adInfo;</span><br><span class="line"></span><br><span class="line">  SplashModel(</span><br><span class="line">      &#123;<span class="keyword">this</span>.version,</span><br><span class="line">      <span class="keyword">this</span>.nextShowGuide,</span><br><span class="line">      <span class="keyword">this</span>.updateGuideInfo,</span><br><span class="line">      <span class="keyword">this</span>.updateAdInfo,</span><br><span class="line">      <span class="keyword">this</span>.guideInfo,</span><br><span class="line">      <span class="keyword">this</span>.adInfo&#125;);</span><br><span class="line"></span><br><span class="line">  SplashModel.fromJson(<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt; json)</span><br><span class="line">      : version = json[<span class="string">'version'</span>],</span><br><span class="line">        nextShowGuide = json[<span class="string">'nextShowGuide'</span>],</span><br><span class="line">        updateGuideInfo = json[<span class="string">'updateGuideInfo'</span>],</span><br><span class="line">        updateAdInfo = json[<span class="string">'updateAdInfo'</span>],</span><br><span class="line">        guideInfo = json[<span class="string">'guideInfo'</span>] == <span class="keyword">null</span></span><br><span class="line">            ? <span class="keyword">null</span></span><br><span class="line">            : SplashGuideModel.fromJson(json[<span class="string">'guideInfo'</span>]),</span><br><span class="line">        adInfo = json[<span class="string">'adInfo'</span>] == <span class="keyword">null</span></span><br><span class="line">            ? <span class="keyword">null</span></span><br><span class="line">            : SplashAdModel.fromJson(json[<span class="string">'adInfo'</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt; toJson() =&gt; &#123;</span><br><span class="line">        <span class="string">'version'</span>: version,</span><br><span class="line">        <span class="string">'nextShowGuide'</span>: nextShowGuide,</span><br><span class="line">        <span class="string">'updateGuideInfo'</span>: updateGuideInfo,</span><br><span class="line">        <span class="string">'updateAdInfo'</span>: updateAdInfo,</span><br><span class="line">        <span class="string">'guideInfo'</span>: guideInfo?.toJson(),</span><br><span class="line">        <span class="string">'adInfo'</span>: adInfo?.toJson(),</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">String</span> toString() &#123;</span><br><span class="line">    <span class="built_in">StringBuffer</span> sb = <span class="keyword">new</span> <span class="built_in">StringBuffer</span>(<span class="string">'&#123;'</span>);</span><br><span class="line">    sb.write(<span class="string">"\"version\":\"<span class="subst">$version</span>\""</span>);</span><br><span class="line">    sb.write(<span class="string">"\"nextShowGuide\":\"<span class="subst">$nextShowGuide</span>\""</span>);</span><br><span class="line">    sb.write(<span class="string">",\"updateGuideInfo\":\"<span class="subst">$updateGuideInfo</span>\""</span>);</span><br><span class="line">    sb.write(<span class="string">",\"updateAdInfo\":\"<span class="subst">$updateAdInfo</span>\""</span>);</span><br><span class="line">    sb.write(<span class="string">",\"guideInfo\":\"<span class="subst">$guideInfo</span>\""</span>);</span><br><span class="line">    sb.write(<span class="string">",\"adInfo\":\"<span class="subst">$adInfo</span>\""</span>);</span><br><span class="line">    sb.write(<span class="string">'&#125;'</span>);</span><br><span class="line">    <span class="keyword">return</span> sb.toString();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="2">
<li><p>SP访问封装工具类（shared_preferences）：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'dart:async'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'dart:convert'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:shared_preferences/shared_preferences.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// SpUtils spUtils = SpUtils();</span></span><br><span class="line"><span class="comment">/// or SpUtils spUtils = SpUtils.instance;</span></span><br><span class="line"><span class="comment">/// await spUtils.initializationDone;  //初始化完成</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpUtils</span> </span>&#123;</span><br><span class="line">  <span class="comment">//单体实例</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> SpUtils _singleton = <span class="keyword">new</span> SpUtils._internal();</span><br><span class="line"></span><br><span class="line">  <span class="comment">//工厂模式 和 静态实例</span></span><br><span class="line">  <span class="keyword">factory</span> SpUtils() =&gt; _singleton;</span><br><span class="line">  <span class="keyword">static</span> SpUtils <span class="keyword">get</span> instance =&gt; _singleton;</span><br><span class="line"></span><br><span class="line">  Future _doneFuture;</span><br><span class="line">  Future <span class="keyword">get</span> initializationDone =&gt; _doneFuture;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//私有构造</span></span><br><span class="line">  SpUtils._internal() &#123;</span><br><span class="line">    _doneFuture = _init();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  SharedPreferences _prefs;</span><br><span class="line">  Future _init() <span class="keyword">async</span> &#123;</span><br><span class="line">    _prefs = <span class="keyword">await</span> SharedPreferences.getInstance();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future&lt;<span class="built_in">bool</span>&gt; putObject(<span class="built_in">String</span> key, <span class="built_in">Object</span> value) &#123;</span><br><span class="line">    <span class="keyword">return</span> _prefs.setString(key, value == <span class="keyword">null</span> ? <span class="string">""</span> : json.encode(value));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Map</span> getObject(<span class="built_in">String</span> key) &#123;</span><br><span class="line">    <span class="built_in">String</span> _data = _prefs.getString(key);</span><br><span class="line">    <span class="keyword">return</span> (_data == <span class="keyword">null</span> || _data.isEmpty) ? <span class="keyword">null</span> : json.decode(_data);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future&lt;<span class="built_in">bool</span>&gt; putObjectList(<span class="built_in">String</span> key, <span class="built_in">List</span>&lt;<span class="built_in">Object</span>&gt; list) &#123;</span><br><span class="line">    <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; _dataList = list?.map((value) &#123;</span><br><span class="line">      <span class="keyword">return</span> json.encode(value);</span><br><span class="line">    &#125;)?.toList();</span><br><span class="line">    <span class="keyword">return</span> _prefs.setStringList(key, _dataList);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">List</span>&lt;<span class="built_in">Map</span>&gt; getObjectList(<span class="built_in">String</span> key) &#123;</span><br><span class="line">    <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; dataLis = _prefs.getStringList(key);</span><br><span class="line">    <span class="keyword">return</span> dataLis?.map((value) &#123;</span><br><span class="line">      <span class="built_in">Map</span> _dataMap = json.decode(value);</span><br><span class="line">      <span class="keyword">return</span> _dataMap;</span><br><span class="line">    &#125;)?.toList();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">String</span> getString(<span class="built_in">String</span> key, &#123;<span class="built_in">String</span> defaultValue: <span class="string">''</span>&#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> _prefs.getString(key) ?? defaultValue;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future&lt;<span class="built_in">bool</span>&gt; putString(<span class="built_in">String</span> key, <span class="built_in">String</span> value) &#123;</span><br><span class="line">    <span class="keyword">return</span> _prefs.setString(key, value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">bool</span> getBool(<span class="built_in">String</span> key, &#123;<span class="built_in">bool</span> defaultValue: <span class="keyword">false</span>&#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> _prefs.getBool(key) ?? defaultValue;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future&lt;<span class="built_in">bool</span>&gt; putBool(<span class="built_in">String</span> key, <span class="built_in">bool</span> value) &#123;</span><br><span class="line">    <span class="keyword">return</span> _prefs.setBool(key, value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">int</span> getInt(<span class="built_in">String</span> key, &#123;<span class="built_in">int</span> defaultValue: <span class="number">0</span>&#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> _prefs.getInt(key) ?? defaultValue;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future&lt;<span class="built_in">bool</span>&gt; putInt(<span class="built_in">String</span> key, <span class="built_in">int</span> value) &#123;</span><br><span class="line">    <span class="keyword">return</span> _prefs.setInt(key, value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">double</span> getDouble(<span class="built_in">String</span> key, &#123;<span class="built_in">double</span> defaultValue: <span class="number">0.0</span>&#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> _prefs.getDouble(key) ?? defaultValue;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future&lt;<span class="built_in">bool</span>&gt; putDouble(<span class="built_in">String</span> key, <span class="built_in">double</span> value) &#123;</span><br><span class="line">    <span class="keyword">return</span> _prefs.setDouble(key, value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; getStringList(<span class="built_in">String</span> key, &#123;<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; defaultValue: <span class="keyword">const</span> []&#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> _prefs.getStringList(key) ?? defaultValue;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future&lt;<span class="built_in">bool</span>&gt; putStringList(<span class="built_in">String</span> key, <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; value) &#123;</span><br><span class="line">    <span class="keyword">return</span> _prefs.setStringList(key, value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">dynamic</span> getDynamic(<span class="built_in">String</span> key, &#123;<span class="built_in">Object</span> defaultValue&#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> _prefs.<span class="keyword">get</span>(key) ?? defaultValue;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">bool</span> haveKey(<span class="built_in">String</span> key) &#123;</span><br><span class="line">    <span class="keyword">return</span> _prefs.getKeys().contains(key);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Set</span>&lt;<span class="built_in">String</span>&gt; getKeys() &#123;</span><br><span class="line">    <span class="keyword">return</span> _prefs.getKeys();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future&lt;<span class="built_in">bool</span>&gt; remove(<span class="built_in">String</span> key) &#123;</span><br><span class="line">    <span class="keyword">return</span> _prefs.remove(key);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future&lt;<span class="built_in">bool</span>&gt; clear() &#123;</span><br><span class="line">    <span class="keyword">return</span> _prefs.clear();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现Dart语言模式的单体类（Singleton）模式，由于shared_preferences的初始化时异步的，需要调用方使用前通过<code>await spUtils.initializationDone;</code>完成初始化工作才能正常后续使用。（<strong>注意:</strong> 整体体验上这一点在Flutter和Dart语言设计上还是比较复杂的，对一些必须的系统依赖，需要额外关注异步和同步处理流程之间的衔接。）</p>
</li>
</ol>
<ol start="3">
<li><p>封装Http库Dio的实现。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'dart:io'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'dart:convert'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:dio/dio.dart'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="string">'package:dio/dio.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:cookie_jar/cookie_jar.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter/foundation.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> dio = <span class="keyword">new</span> MyDio();</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyDio</span> <span class="keyword">extends</span> <span class="title">Dio</span> </span>&#123;</span><br><span class="line">  MyDio([BaseOptions options]) : <span class="keyword">super</span>(options) &#123;</span><br><span class="line">    <span class="keyword">super</span>.interceptors</span><br><span class="line">      ..add(CookieManager(CookieJar()))</span><br><span class="line">      ..add(LogInterceptor(responseBody: <span class="keyword">true</span>));</span><br><span class="line">    (<span class="keyword">super</span>.transformer <span class="keyword">as</span> DefaultTransformer).jsonDecodeCallback = parseJson;</span><br><span class="line">    <span class="keyword">super</span>.options.receiveTimeout = <span class="number">15000</span>;</span><br><span class="line">    <span class="keyword">super</span>.options.validateStatus = (<span class="built_in">int</span> status) &#123;</span><br><span class="line">      <span class="keyword">return</span> status &gt;= HttpStatus.ok &amp;&amp; status &lt; HttpStatus.multipleChoices ||</span><br><span class="line">          status == HttpStatus.notModified;</span><br><span class="line">      <span class="comment">//return status &gt;= HttpStatus.ok &amp;&amp; status &lt; 300 || status == 304;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//TODO 认证Token追加到Header的处理</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Must be top-level function</span></span><br><span class="line">_parseAndDecode(<span class="built_in">String</span> response) &#123;</span><br><span class="line">  <span class="keyword">return</span> jsonDecode(response);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">parseJson(<span class="built_in">String</span> text) &#123;</span><br><span class="line">  <span class="keyword">return</span> compute(_parseAndDecode, text);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//全局方便约束的变量</span></span><br><span class="line"><span class="keyword">final</span> Options expectHttpOK = Options(</span><br><span class="line">  validateStatus: (<span class="built_in">int</span> status) &#123;</span><br><span class="line">    <span class="keyword">return</span> status == HttpStatus.ok; <span class="comment">//200</span></span><br><span class="line">  &#125;,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> Options expectHttpCreated = Options(</span><br><span class="line">  validateStatus: (<span class="built_in">int</span> status) &#123;</span><br><span class="line">    <span class="keyword">return</span> status == HttpStatus.created; <span class="comment">//201</span></span><br><span class="line">  &#125;,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>构建全局变量dio，实现了继承Dio子类MyDio，封装了通用初始化设置：Cookie处理、日志、JSON转换（reponse中的ContentType是application/json; charset=utf-8的时候，会自动把结果JSON字符串转换成JSON Map）、访问超时、默认返回有效状态校验。</p>
</li>
</ol>
<ol start="4">
<li><p>封装后端数据访问API。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'./http_dio.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:flutterpoc/models/index.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SplashApi</span> </span>&#123;</span><br><span class="line">  <span class="comment">//Online JSON REST mock server, all data is in db.json</span></span><br><span class="line">  <span class="comment">//具有1分钟数据缓存，测试需要等待数据刷新</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">String</span> splash_base_url =</span><br><span class="line">      <span class="string">'https://my-json-server.typicode.com/dragonetail/flutterpoc'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> Future&lt;SplashModel&gt; getSplashMode([<span class="built_in">String</span> version = <span class="string">''</span>]) <span class="keyword">async</span> &#123;</span><br><span class="line">    &#123;</span><br><span class="line">      Response response = <span class="keyword">await</span> dio.<span class="keyword">get</span>(</span><br><span class="line">        splash_base_url + <span class="string">'/splash'</span>,</span><br><span class="line">        queryParameters: &#123;<span class="string">"version"</span>: version&#125;,</span><br><span class="line">        options: expectHttpOK,</span><br><span class="line">      );</span><br><span class="line">      <span class="built_in">print</span>(response.data);</span><br><span class="line">      <span class="keyword">return</span> SplashModel.fromJson(response.data);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>封装后端访问数据的API实现。这里使用了<code>my-json-server.typicode.com</code>利用Github上的JSON文件实现模拟REST JSON访问请求。</p>
</li>
</ol>
<ol start="5">
<li><p>封装Model数据的访问Service。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'dart:convert'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:flutterpoc/models/index.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:flutterpoc/common/index.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:flutterpoc/api/index.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SplashService</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">String</span> splash_version = <span class="string">'splash.version'</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">String</span> splash_ad_mode = <span class="string">'splash.ad.mode'</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">String</span> splash_ad_model = <span class="string">'splash.ad.model'</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">String</span> splash_guide_model = <span class="string">'splash.guide.model'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> SpUtils spUtils = SpUtils.instance;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="built_in">bool</span> isSplashAdMode() &#123;</span><br><span class="line">    <span class="keyword">return</span> spUtils.getBool(splash_ad_mode);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">void</span> clearSplashAdMode() &#123;</span><br><span class="line">    spUtils.remove(splash_ad_mode);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">void</span> setSplashAdMode() &#123;</span><br><span class="line">    spUtils.putBool(splash_ad_mode, <span class="keyword">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> SplashAdModel getSplashAdModel([SplashAdModel defaultValue]) &#123;</span><br><span class="line">    <span class="built_in">String</span> _splashModel = spUtils.getString(splash_ad_model);</span><br><span class="line">    <span class="keyword">if</span> (CommonUtils.isNotEmpty(_splashModel)) &#123;</span><br><span class="line">      <span class="built_in">Map</span> userMap = json.decode(_splashModel);</span><br><span class="line">      <span class="keyword">return</span> SplashAdModel.fromJson(userMap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> defaultValue;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> SplashGuideModel getSplashGuideModel([SplashGuideModel defaultValue]) &#123;</span><br><span class="line">    <span class="built_in">String</span> _splashModel = spUtils.getString(splash_guide_model);</span><br><span class="line">    <span class="keyword">if</span> (CommonUtils.isNotEmpty(_splashModel)) &#123;</span><br><span class="line">      <span class="built_in">Map</span> userMap = json.decode(_splashModel);</span><br><span class="line">      <span class="keyword">return</span> SplashGuideModel.fromJson(userMap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> defaultValue;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">void</span> updateSplashInfo() &#123;</span><br><span class="line">    <span class="built_in">String</span> version = spUtils.getString(splash_version) ?? <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    Future&lt;SplashModel&gt; future = SplashApi.getSplashMode(version);</span><br><span class="line">    future.then((SplashModel splash) &#123;</span><br><span class="line">      spUtils.putString(splash_version, splash.version ?? <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (splash.nextShowGuide) &#123;</span><br><span class="line">        clearSplashAdMode();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (splash.updateAdInfo &amp;&amp; splash.adInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="built_in">String</span> _jsonStr = json.encode(splash.adInfo.toJson());</span><br><span class="line">        spUtils.putString(splash_ad_model, _jsonStr);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (splash.updateGuideInfo &amp;&amp; splash.guideInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="built_in">String</span> _jsonStr = json.encode(splash.guideInfo.toJson());</span><br><span class="line">        spUtils.putString(splash_guide_model, _jsonStr);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, onError: (error) &#123;</span><br><span class="line">      <span class="built_in">print</span>(error);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现了对SP数据访问的封装，并提供一个对API访问后端数据的更新到SP的封装。</p>
</li>
</ol>
<ol start="6">
<li><p>构建BLOC，组合数据和状态控制。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'dart:async'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:flutterpoc/common/index.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:flutterpoc/models/index.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:flutterpoc/services/index.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SplashBloc</span> <span class="keyword">extends</span> <span class="title">BaseBloc</span>&lt;<span class="title">BaseEvent</span>, <span class="title">BaseState</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  BaseState <span class="keyword">get</span> initialState &#123;</span><br><span class="line">    _init();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> SplashInitialState();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> _init() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="comment">//等待SP初始化完毕</span></span><br><span class="line">    <span class="keyword">await</span> SpUtils.instance.initializationDone;</span><br><span class="line">    <span class="keyword">if</span> (SplashService.isSplashAdMode()) &#123;</span><br><span class="line">      <span class="keyword">this</span>.dispatch(SplashAdEvent());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.dispatch(SplashGuideEvent());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3秒之后获取服务器最新的Splash信息，更新本地存储</span></span><br><span class="line">    Future.delayed(<span class="keyword">const</span> <span class="built_in">Duration</span>(seconds: <span class="number">3</span>), () &#123;</span><br><span class="line">      SplashService.updateSplashInfo();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">Map</span>&lt;<span class="built_in">Type</span>, <span class="built_in">Function</span>(BaseEvent)&gt; <span class="keyword">get</span> mapper =&gt; &#123;</span><br><span class="line">        SplashGuideEvent: _mapSplashGuideEventToState,</span><br><span class="line">        SplashAdEvent: _mapSplashAdEventToState,</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">  Stream&lt;BaseState&gt; _mapSplashGuideEventToState(BaseEvent event) <span class="keyword">async</span>* &#123;</span><br><span class="line">    SplashGuideModel splashGuideModel =</span><br><span class="line">        SplashService.getSplashGuideModel(SplashGuideModel(</span><br><span class="line">      isUrl: <span class="keyword">false</span>,</span><br><span class="line">      images: [</span><br><span class="line">        Utils.getImgPath(<span class="string">'guide1'</span>, format: <span class="string">'jpg'</span>),</span><br><span class="line">        Utils.getImgPath(<span class="string">'guide2'</span>, format: <span class="string">'jpg'</span>),</span><br><span class="line">        Utils.getImgPath(<span class="string">'guide3'</span>, format: <span class="string">'jpg'</span>),</span><br><span class="line">        Utils.getImgPath(<span class="string">'guide4'</span>, format: <span class="string">'jpg'</span>),</span><br><span class="line">      ],</span><br><span class="line">      textInfos: [</span><br><span class="line">        <span class="string">"在你需要的每个地方"</span>,</span><br><span class="line">        <span class="string">"载你去往每个地方"</span>,</span><br><span class="line">        <span class="string">"懂你，更懂你所行"</span>,</span><br><span class="line">        <span class="string">"因为在意，所以用心"</span>,</span><br><span class="line">      ],</span><br><span class="line">    ));</span><br><span class="line">    <span class="keyword">yield</span> SplashGuideState(splashGuideModel);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Stream&lt;BaseState&gt; _mapSplashAdEventToState(BaseEvent event) <span class="keyword">async</span>* &#123;</span><br><span class="line">    SplashAdModel splashAdModel = SplashService.getSplashAdModel(SplashAdModel(</span><br><span class="line">      title: <span class="string">'带你去旅行'</span>,</span><br><span class="line">      imageUrl:</span><br><span class="line">          <span class="string">'https://raw.githubusercontent.com/dragonetail/flutterpoc/master/assets/images/3.0x/ad.jpg'</span>,</span><br><span class="line">      targetUrl: <span class="string">'https://github.com/dragonetail/flutterpoc/'</span>,</span><br><span class="line">    ));</span><br><span class="line">    <span class="keyword">yield</span> SplashAdState(splashAdModel);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Event定义</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SplashGuideEvent</span> <span class="keyword">extends</span> <span class="title">BaseEvent</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SplashAdEvent</span> <span class="keyword">extends</span> <span class="title">BaseEvent</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//State定义</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SplashInitialState</span> <span class="keyword">extends</span> <span class="title">BaseState</span> </span>&#123;</span><br><span class="line">  SplashInitialState() : <span class="keyword">super</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SplashGuideState</span> <span class="keyword">extends</span> <span class="title">BaseState</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> SplashGuideModel splashGuideModel;</span><br><span class="line"></span><br><span class="line">  SplashGuideState(<span class="keyword">this</span>.splashGuideModel) : <span class="keyword">super</span>([splashGuideModel]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SplashAdState</span> <span class="keyword">extends</span> <span class="title">BaseState</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> SplashAdModel splashAdModel;</span><br><span class="line"></span><br><span class="line">  SplashAdState(<span class="keyword">this</span>.splashAdModel) : <span class="keyword">super</span>([splashAdModel]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定义了两个状态：SplashGuideEvent、SplashAdEvent；定义了三个状态：SplashInitialState、SplashGuideState、SplashAdState。</p>
<p>通过Event和状态实现Bloc状态迁移控制。</p>
</li>
</ol>
<ol start="7">
<li><p>Page页面构造，实现状态对应Widget的构建和组装。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter/material.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter_bloc/flutter_bloc.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:flutterpoc/common/index.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:flutterpoc/models/index.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:flutterpoc/blocs/index.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:flutterpoc/services/index.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SplashPage</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  SplashPage(&#123;Key key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _SplashPageState createState() =&gt; _SplashPageState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_SplashPageState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">SplashPage</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> SplashBloc _splashBloc = SplashBloc();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      body: BlocBuilder&lt;BaseEvent, BaseState&gt;(</span><br><span class="line">        bloc: _splashBloc,</span><br><span class="line">        builder: (BuildContext context, BaseState baseState) &#123;</span><br><span class="line">          <span class="keyword">if</span> (baseState <span class="keyword">is</span> SplashGuideState) &#123;</span><br><span class="line">            <span class="keyword">return</span> buildSplashGuideWidget(baseState);</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (baseState <span class="keyword">is</span> SplashAdState) &#123;</span><br><span class="line">            <span class="keyword">return</span> buildSplashAdWidget(baseState);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Container();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Widget buildSplashAdWidget(SplashAdState state) &#123;</span><br><span class="line">    SplashAdModel splashAdModel = state.splashAdModel;</span><br><span class="line">    <span class="keyword">return</span> SplashADPage(</span><br><span class="line">      adImageUrl: splashAdModel.imageUrl,</span><br><span class="line">      skipActionTitle: <span class="string">'跳过'</span>,</span><br><span class="line">      skipAction: _skipAction,</span><br><span class="line">      adAction: _adAction,</span><br><span class="line">      count: <span class="number">3</span>,</span><br><span class="line">      logoImagePath: Utils.getImgPath(<span class="string">'splash_logo'</span>),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Widget buildSplashGuideWidget(SplashGuideState state) &#123;</span><br><span class="line">    SplashGuideModel splashGuideModel = state.splashGuideModel;</span><br><span class="line">    <span class="keyword">return</span> SplashGuidePage(</span><br><span class="line">        images: splashGuideModel.images,</span><br><span class="line">        textInfos: splashGuideModel.textInfos,</span><br><span class="line">        nextActionTitle: <span class="string">'立即启程'</span>,</span><br><span class="line">        nextAction: _nextActionFromGuide);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> _nextActionFromGuide() &#123;</span><br><span class="line">    SplashService.setSplashAdMode();</span><br><span class="line">    Navigator.of(context).pushReplacementNamed(<span class="string">'/Main'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> _skipAction() &#123;</span><br><span class="line">    Navigator.of(context).pushReplacementNamed(<span class="string">'/Main'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> _adAction() &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(_splashBloc.currentState <span class="keyword">is</span> SplashAdState)) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    SplashAdModel splashAdModel =</span><br><span class="line">        (_splashBloc.currentState <span class="keyword">as</span> SplashAdState).splashAdModel;</span><br><span class="line"></span><br><span class="line">    Navigator.of(context).pushReplacementNamed(<span class="string">'/Main'</span>);</span><br><span class="line">    NavigatorUtil.pushWeb(context,</span><br><span class="line">        title: splashAdModel.title, url: splashAdModel.targetUrl);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> dispose() &#123;</span><br><span class="line">    _splashBloc.dispose();</span><br><span class="line">    <span class="keyword">super</span>.dispose();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="8">
<li><p>APP入口定义SplashPage的使用。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="comment">// This widget is the root of your application.</span></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> MaterialApp(</span><br><span class="line">      title: <span class="string">'Flutter Demo'</span>,</span><br><span class="line">      theme: ThemeData(</span><br><span class="line">        primarySwatch: Colors.blue,</span><br><span class="line">      ),</span><br><span class="line">      routes: &#123;</span><br><span class="line">        <span class="string">'/Main'</span>: (ctx) =&gt; CounterPage(),</span><br><span class="line">      &#125;,</span><br><span class="line">      home: SplashPage(),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="9">
<li>Splash共通组件： SplashGuidePage、SplashADPage，构建对应具体画面布局和内容显示。代码请直接查看Github。</li>
</ol>
<ol start="10">
<li>结论： 在整体上，使用Bloc架构、包括SP本地存储、HTTP API远程访问在一起的Splash实现，整体组件隔离还是相当清晰简单的。</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://dragonetail.github.io/2019/04/08/Flutter的Bloc工程化系列2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黑哈">
      <meta itemprop="description" content="~黑哈等你回家~">
      <meta itemprop="image" content="/images/blackharry1.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="微笑卡卡西">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/08/Flutter的Bloc工程化系列2/" class="post-title-link" itemprop="url">Flutter的Bloc工程化系列2</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-04-08 10:51:48 / 修改时间：10:52:40" itemprop="dateCreated datePublished" datetime="2019-04-08T10:51:48+08:00">2019-04-08</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/APP编程/" itemprop="url" rel="index"><span itemprop="name">APP编程</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="BLOC重构Counter实现（BLOC逻辑处理工程简化）"><a href="#BLOC重构Counter实现（BLOC逻辑处理工程简化）" class="headerlink" title="BLOC重构Counter实现（BLOC逻辑处理工程简化）"></a>BLOC重构Counter实现（BLOC逻辑处理工程简化）</h1><p><strong>说明：</strong> 本部分完成部分在分支： <a href="https://github.com/dragonetail/flutterpoc/tree/2-counter_refactor_simplication" target="_blank" rel="noopener">https://github.com/dragonetail/flutterpoc/tree/2-counter_refactor_simplication</a></p>
<p><strong>目标：</strong> 根据Flutter缺省计数器例子，遵循Bloc的理念实现增减计数器的逻辑和视图分离，在第一步的基础上，抽取BaseBloc实现，简化Bloc的处理逻辑和工程化。</p>
<ol>
<li><p>在的counter_bloc.dart基础上，抽取BaseBloc、BaseEvent、BaseState三个抽象基类。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'dart:async'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:bloc/bloc.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:equatable/equatable.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:meta/meta.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseBloc</span>&lt;<span class="title">Event</span> <span class="keyword">extends</span> <span class="title">BaseEvent</span>, <span class="title">State</span> <span class="keyword">extends</span> <span class="title">BaseState</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">Bloc</span>&lt;<span class="title">Event</span>, <span class="title">State</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">//Event到State映射函数表</span></span><br><span class="line">  <span class="built_in">Map</span>&lt;<span class="built_in">Type</span>, <span class="built_in">Function</span>(Event)&gt; <span class="keyword">get</span> mapper;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Stream&lt;State&gt; mapEventToState(</span><br><span class="line">    Event event,</span><br><span class="line">  ) <span class="keyword">async</span>* &#123;</span><br><span class="line">    <span class="keyword">if</span> (mapper == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">Type</span> type = event.runtimeType;</span><br><span class="line">    <span class="keyword">var</span> function = mapper[type];</span><br><span class="line">    <span class="keyword">if</span> (function == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">yield</span>* function(event);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@immutable</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseEvent</span> <span class="keyword">extends</span> <span class="title">Equatable</span> </span>&#123;</span><br><span class="line">  BaseEvent([<span class="built_in">List</span> props = <span class="keyword">const</span> []]) : <span class="keyword">super</span>(props);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@immutable</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseState</span> <span class="keyword">extends</span> <span class="title">Equatable</span> </span>&#123;</span><br><span class="line">  BaseState([<span class="built_in">List</span> props = <span class="keyword">const</span> []]) : <span class="keyword">super</span>(props);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对mapEventToState进行了默认实现，根据<code>Map&lt;Type, Function(Event)&gt; get mapper</code>定义的【Event到State映射函数表】进行业务逻辑函数的dispatch操作，简化业务逻辑的if级联判断。</p>
</li>
<li><p>再看看counter_bloc.dart的实现：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'dart:async'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'../blocs.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CounterBloc</span> <span class="keyword">extends</span> <span class="title">BaseBloc</span>&lt;<span class="title">CounterEvent</span>, <span class="title">CounterState</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  CounterState <span class="keyword">get</span> initialState =&gt; CountingState(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">Map</span>&lt;<span class="built_in">Type</span>, <span class="built_in">Function</span>(CounterEvent)&gt; <span class="keyword">get</span> mapper =&gt; &#123;</span><br><span class="line">        IncrementEvent: _mapIncrementEventToState,</span><br><span class="line">        DecrementEvent: _mapDecrementEventToState,</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">  Stream&lt;CounterState&gt; _mapIncrementEventToState(CounterEvent event) <span class="keyword">async</span>* &#123;</span><br><span class="line">    <span class="keyword">yield</span> CountingState((currentState <span class="keyword">as</span> CountingState).counter + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Stream&lt;CounterState&gt; _mapDecrementEventToState(CounterEvent event) <span class="keyword">async</span>* &#123;</span><br><span class="line">    <span class="keyword">yield</span> CountingState((currentState <span class="keyword">as</span> CountingState).counter - <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Event定义</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CounterEvent</span> <span class="keyword">extends</span> <span class="title">BaseEvent</span></span>&#123;</span><br><span class="line">  CounterEvent([<span class="built_in">List</span> props = <span class="keyword">const</span> []]) : <span class="keyword">super</span>(props);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IncrementEvent</span> <span class="keyword">extends</span> <span class="title">CounterEvent</span></span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DecrementEvent</span> <span class="keyword">extends</span> <span class="title">CounterEvent</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//State定义</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CounterState</span> <span class="keyword">extends</span> <span class="title">BaseState</span></span>&#123;</span><br><span class="line">  CounterState([<span class="built_in">List</span> props = <span class="keyword">const</span> []]) : <span class="keyword">super</span>(props);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CountingState</span> <span class="keyword">extends</span> <span class="title">CounterState</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">int</span> counter;</span><br><span class="line"></span><br><span class="line">  CountingState(<span class="keyword">this</span>.counter) : <span class="keyword">super</span>([counter]);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">String</span> toString() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'CountingState &#123; counter: <span class="subst">$counter</span> &#125;'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过重载<code>Map&lt;Type, Function(CounterEvent)&gt; get mapper =&gt; {</code>定义了两个Event类到对应处理方法的映射表。</p>
<p>统一映射方法的处理，接受<code>CounterEvent event</code>，返回<code>Stream&lt;CounterState&gt;</code>。</p>
<p>同时简化Event和State的定义，整个所有Bloc相关的内容都放到一个文件中，减少文件拆分，简化工程化开发的复杂度。</p>
<p>【研讨】在这个抽取过程中，通过BaseEvent、BaseState的抽取，技术上应该不需要CounterEvent、CounterState进行过渡，直接在映射方法的参数和返回值上使用BaseEvent、BaseState，是不是会更好？</p>
</li>
</ol>
<ol start="3">
<li>结论： 整体上，这样基本对于业务逻辑拆分隔离来说，复杂度已经降低到类似Spring框架的水平附近了。</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://dragonetail.github.io/2019/04/07/Flutter的Bloc工程化系列1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黑哈">
      <meta itemprop="description" content="~黑哈等你回家~">
      <meta itemprop="image" content="/images/blackharry1.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="微笑卡卡西">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/07/Flutter的Bloc工程化系列1/" class="post-title-link" itemprop="url">Flutter的Bloc工程化系列1</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-04-07 23:08:33" itemprop="dateCreated datePublished" datetime="2019-04-07T23:08:33+08:00">2019-04-07</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-04-18 22:10:36" itemprop="dateModified" datetime="2019-04-18T22:10:36+08:00">2019-04-18</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/APP编程/" itemprop="url" rel="index"><span itemprop="name">APP编程</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="BLOC重构Counter实现（Flutter的Bloc工程化系列1）"><a href="#BLOC重构Counter实现（Flutter的Bloc工程化系列1）" class="headerlink" title="BLOC重构Counter实现（Flutter的Bloc工程化系列1）"></a>BLOC重构Counter实现（Flutter的Bloc工程化系列1）</h1><p><strong>说明：</strong> 本部分完成部分在分支： <a href="https://github.com/dragonetail/flutterpoc/tree/counter_refactor" target="_blank" rel="noopener">https://github.com/dragonetail/flutterpoc/tree/counter_refactor</a></p>
<p><strong>目标：</strong> 根据Flutter缺省计数器例子，遵循Bloc的理念实现增减计数器的逻辑和视图分离。</p>
<ol>
<li><p>使用fluter命令创建APP，然后在pubspec.yaml中追加依赖</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cupertino_icons:</span> <span class="string">^0.1.2</span></span><br><span class="line"><span class="attr">flutter_bloc:</span> <span class="string">^0.9.1</span></span><br><span class="line"><span class="attr">meta:</span> <span class="string">"&gt;=1.1.6 &lt;2.0.0"</span></span><br><span class="line"><span class="attr">equatable:</span> <span class="string">^0.2.0</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>环境准备，使用vscode，安装bloc的插件辅助代码生成。<br>参考： <a href="https://felangel.github.io/bloc/#/blocvscodeextension&gt;" target="_blank" rel="noopener">https://felangel.github.io/bloc/#/blocvscodeextension&gt;</a><br>直接用这个链接安装： <a href="https://marketplace.visualstudio.com/items?itemName=FelixAngelov.bloc" target="_blank" rel="noopener">https://marketplace.visualstudio.com/items?itemName=FelixAngelov.bloc</a></p>
</li>
<li><p>创建目录结构：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lib</span><br><span class="line">  blocs  #BLOC逻辑代码</span><br><span class="line">  pages  #页面代码</span><br><span class="line">  widgets  #组件代码</span><br></pre></td></tr></table></figure>
</li>
<li><p>在blocs目录下面上右键菜单【Bloc： new bloc】（第二部插件提供功能），输入bloc名字为counter，将创建如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">blocs</span><br><span class="line">  bloc  # 需要手工更改为counter</span><br><span class="line">    bloc.dart               </span><br><span class="line">    counter_bloc.dart       </span><br><span class="line">    counter_event.dart      </span><br><span class="line">    counter_state.dart</span><br></pre></td></tr></table></figure>
<p>更改生成的bloc目录为counter</p>
</li>
<li><p>在blocs下面创建blocs.dart和simple_bloc_delegate.dart，结果文件列表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">blocs</span><br><span class="line">  counter  </span><br><span class="line">    bloc.dart               </span><br><span class="line">    counter_bloc.dart       </span><br><span class="line">    counter_event.dart      </span><br><span class="line">    counter_state.dart</span><br><span class="line">  blocs.dart</span><br><span class="line">  simple_bloc_delegate.dart</span><br></pre></td></tr></table></figure>
</li>
<li><p>counter目录下面生成的文件内容和修改结果：</p>
<ul>
<li>首先是package的索引，bloc.dart，是当前目录下面内容的export索引文件。内容：</li>
</ul>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="string">'counter_bloc.dart'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="string">'counter_event.dart'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="string">'counter_state.dart'</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>事件counter_event.dart文件，为计数器业务逻辑的事物定义。根据Bloc官网资料<a href="https://felangel.github.io/bloc/#/fluttercountertutorial" target="_blank" rel="noopener">https://felangel.github.io/bloc/#/fluttercountertutorial</a>的做法看，可以简单使用Enum来实现Event定义，使用int实现state的处理。作为工程化探讨，这里使用标准的Bloc做法进行处理。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:equatable/equatable.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:meta/meta.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@immutable</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CounterEvent</span> <span class="keyword">extends</span> <span class="title">Equatable</span> </span>&#123;</span><br><span class="line">  CounterEvent([<span class="built_in">List</span> props = <span class="keyword">const</span> []]) : <span class="keyword">super</span>(props);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IncrementEvent</span> <span class="keyword">extends</span> <span class="title">CounterEvent</span> </span>&#123;</span><br><span class="line">  IncrementEvent() : <span class="keyword">super</span>();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">String</span> toString() =&gt; <span class="string">'IncrementEvent'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DecrementEvent</span> <span class="keyword">extends</span> <span class="title">CounterEvent</span> </span>&#123;</span><br><span class="line">  DecrementEvent() : <span class="keyword">super</span>();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">String</span> toString() =&gt; <span class="string">'DecrementEvent '</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个地方使用了增强Equatable组件，Bloc官网没有说明，应该属于增强组件相等性判断的实现，暂不追究原理。</p>
<p>根据Bloc的模板，首先实现了一个抽象类，这个抽象类声明了【@immutable】，则其所有子类都不可变更，即不能有可变的成员变量（表达某种特定事件实例的含义）。</p>
<p>上面例子，通过实例化实现了两个Event类型，IncrementEvent和DecrementEvent。</p>
<p>【最佳实践】查看了Bloc的其他示例，这个地方规约没有统一化，建议所有的Event实例类都以Event结尾。</p>
</li>
<li><p>计数器状态控制counter_state.dart：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:equatable/equatable.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:meta/meta.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@immutable</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CounterState</span> <span class="keyword">extends</span> <span class="title">Equatable</span> </span>&#123;</span><br><span class="line">  CounterState([<span class="built_in">List</span> props = <span class="keyword">const</span> []]) : <span class="keyword">super</span>(props);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CountingState</span> <span class="keyword">extends</span> <span class="title">CounterState</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">int</span> counter;</span><br><span class="line"></span><br><span class="line">  CountingState(<span class="keyword">this</span>.counter) : <span class="keyword">super</span>([counter]);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">String</span> toString() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'CountingState &#123; counter: <span class="subst">$counter</span> &#125;'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同Event，state的实现也基本一样，通过【@immutable】约束了所有State类为不可变（表达某种特定状态实例的含义）。</p>
<p>上面例子，实例化实现了一个状态CountingState，表达了技术过程中的某一时刻的状态，其有一个成员变量counter表示计数器的状态，通过构造函数初始化，不可改变。</p>
<p>【最佳实践】所有状态实例类以State结尾。</p>
<p>【其他】同Swift语言一样，Dart语言也依赖变量直接暴露出来进行数据交互，不使用setter和getter方法。</p>
</li>
<li><p>业务逻辑counter_bloc.dart实现：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'dart:async'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:bloc/bloc.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'./bloc.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CounterBloc</span> <span class="keyword">extends</span> <span class="title">Bloc</span>&lt;<span class="title">CounterEvent</span>, <span class="title">CounterState</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  CounterState <span class="keyword">get</span> initialState =&gt; CountingState(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Stream&lt;CounterState&gt; mapEventToState(</span><br><span class="line">    CounterEvent event,</span><br><span class="line">  ) <span class="keyword">async</span>* &#123;</span><br><span class="line">    <span class="keyword">if</span> (event <span class="keyword">is</span> IncrementEvent) &#123;</span><br><span class="line">      <span class="keyword">yield</span>* _mapIncrementEventToState();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event <span class="keyword">is</span> DecrementEvent) &#123;</span><br><span class="line">      <span class="keyword">yield</span>* _mapDecrementEventState(event);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Stream&lt;CountingState&gt; _mapIncrementEventToState() <span class="keyword">async</span>* &#123;</span><br><span class="line">    <span class="keyword">yield</span> CountingState((currentState <span class="keyword">as</span> CountingState).counter + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Stream&lt;CountingState&gt; _mapDecrementEventState(DecrementEvent event) <span class="keyword">async</span>* &#123;</span><br><span class="line">    <span class="keyword">yield</span> CountingState((currentState <span class="keyword">as</span> CountingState).counter - <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先需要通过重载实现initialState的实现，Bloc框架会实现当前bloc的状态，通过变量currentState访问。</p>
<p>业务逻辑主要放到mapEventToState进行处理，根据Bloc的实践例子，这个地方主要是通过event类型进行判断，调用不同的本地私有map函数进行分类处理。</p>
<p>mapEventToState的返回类型是<code>Stream&lt;State&gt;</code>类型，表达状态流。</p>
</li>
</ul>
</li>
<li><p>blocs下面blocs.dart和simple_bloc_delegate.dart：</p>
<ul>
<li><p>blocs.dart是export索引。</p>
</li>
<li><p>simple_bloc_delegate.dart是根据官网示例对Bloc的默认delegate进行扩展，追加Debug日志功能：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:bloc/bloc.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleBlocDelegate</span> <span class="keyword">extends</span> <span class="title">BlocDelegate</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> onTransition(Transition transition) &#123;</span><br><span class="line">    <span class="keyword">super</span>.onTransition(transition);</span><br><span class="line">    <span class="built_in">print</span>(transition);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> onError(<span class="built_in">Object</span> error, StackTrace stacktrace) &#123;</span><br><span class="line">    <span class="keyword">super</span>.onError(error, stacktrace);</span><br><span class="line">    <span class="built_in">print</span>(error);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定义了这个，需要在APP启动时在main.dart中进行设定使用。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  BlocSupervisor().delegate = SimpleBlocDelegate();</span><br><span class="line"></span><br><span class="line">  runApp(MyApp());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>改写MyHomePage：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter/material.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter_bloc/flutter_bloc.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:flutterpoc/pages/pages.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:flutterpoc/blocs/blocs.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyHomePage</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  MyHomePage(&#123;Key key, <span class="keyword">this</span>.title&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> title;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _MyHomePageState createState() =&gt; _MyHomePageState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_MyHomePageState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">MyHomePage</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> CounterBloc _counterBloc = CounterBloc();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(widget.title),</span><br><span class="line">      ),</span><br><span class="line">      body: BlocProvider&lt;CounterBloc&gt;(</span><br><span class="line">        bloc: _counterBloc,</span><br><span class="line">        child: CounterPage(),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>沿用缺省示例生成的StatefulWidget，并在State中定义了CounterBloc，然后再body处使用BlocProvider把        【bloc: _counterBloc】注入（DI）到Bloc的context中，然后在CounterPage中使用<code>final CounterBloc _counterBloc = BlocProvider.of&lt;CounterBloc&gt;(context);</code>可以获取之前注入的bloc变量。</p>
</li>
<li><p>页面CounterPage的实现：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter/material.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter_bloc/flutter_bloc.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:flutterpoc/blocs/blocs.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:flutterpoc/widgets/widgets.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CounterPage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">final</span> CounterBloc _counterBloc = BlocProvider.of&lt;CounterBloc&gt;(context);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      body: BlocBuilder&lt;CounterEvent, CounterState&gt;(</span><br><span class="line">        bloc: _counterBloc,</span><br><span class="line">        builder: (BuildContext context, CounterState counterState) &#123;</span><br><span class="line">          <span class="keyword">return</span> Center(</span><br><span class="line">            child: Column(</span><br><span class="line">              mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">              children: &lt;Widget&gt;[</span><br><span class="line">                Text(</span><br><span class="line">                  <span class="string">'You have pushed the button this many times:'</span>,</span><br><span class="line">                ),</span><br><span class="line">                Text(</span><br><span class="line">                  <span class="string">'<span class="subst">$&#123;(counterState as CountingState).counter&#125;</span>'</span>,</span><br><span class="line">                  style: TextStyle(fontSize: <span class="number">24.0</span>),</span><br><span class="line">                ),</span><br><span class="line">              ],</span><br><span class="line">            ),</span><br><span class="line">          );</span><br><span class="line">        &#125;,</span><br><span class="line">      ),</span><br><span class="line">      floatingActionButton: Column(</span><br><span class="line">        crossAxisAlignment: CrossAxisAlignment.end,</span><br><span class="line">        mainAxisAlignment: MainAxisAlignment.end,</span><br><span class="line">        children: &lt;Widget&gt;[</span><br><span class="line">          PaddingFloatingActionButton(</span><br><span class="line">            icon: Icons.add,</span><br><span class="line">            onPressed: () =&gt; _counterBloc.dispatch(IncrementEvent()),</span><br><span class="line">          ),</span><br><span class="line">          PaddingFloatingActionButton(</span><br><span class="line">            icon: Icons.remove,</span><br><span class="line">            onPressed: () =&gt; _counterBloc.dispatch(DecrementEvent()),</span><br><span class="line">          )</span><br><span class="line">        ],</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完成了页面布局和内容组合。使用StatelessWidget实现widget构造。通过使用<code>final CounterBloc _counterBloc = BlocProvider.of&lt;CounterBloc&gt;(context);</code>获取之前父节点注入的bloc变量。</p>
<p>通过<code>body: BlocBuilder&lt;CounterEvent, CounterState&gt;(</code>构造实际关键bloc业务的UI组件。</p>
<p>通过<code>&#39;${(counterState as CountingState).counter}&#39;</code>访问State的值，更新显示。</p>
<p>通过通用封装组件PaddingFloatingActionButton实现浮动按钮的可重用组件封装。</p>
<p>【综合】在PaddingFloatingActionButton的onPressed事件中，调用bloc发射事件<code>onPressed: () =&gt; _counterBloc.dispatch(IncrementEvent()),</code>。在Bloc的实现中，根据mapEventToState进行事件到State的映射转换，转换成State后，通过<code>Stream&lt;CounterState&gt;</code>激活<code>body: BlocBuilder&lt;CounterEvent, CounterState&gt;(</code>的重构（重绘）操作，实现Widget的局部更新。</p>
</li>
<li><p>最终更改入口main.dart:</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter/material.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:bloc/bloc.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:flutterpoc/blocs/blocs.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:flutterpoc/pages/pages.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  BlocSupervisor().delegate = SimpleBlocDelegate();</span><br><span class="line"></span><br><span class="line">  runApp(MyApp());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="comment">// This widget is the root of your application.</span></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> MaterialApp(</span><br><span class="line">      title: <span class="string">'Flutter Demo'</span>,</span><br><span class="line">      theme: ThemeData(</span><br><span class="line">        primarySwatch: Colors.blue,</span><br><span class="line">      ),</span><br><span class="line">      home: MyHomePage(title: <span class="string">'Flutter Demo Home Page'</span>),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行截屏：</p>
<p><img src="https://github.com/dragonetail/flutterpoc/raw/counter_refactor/screenshots/counter_refactor.png" alt="增减计数器运行结果"></p>
</li>
</ol>
<h2 id="BLOC参考"><a href="#BLOC参考" class="headerlink" title="BLOC参考"></a>BLOC参考</h2><p>参考：</p>
<ul>
<li><a href="https://pub.dartlang.org/packages/bloc" target="_blank" rel="noopener">https://pub.dartlang.org/packages/bloc</a></li>
<li><a href="https://pub.dartlang.org/packages/flutter_bloc" target="_blank" rel="noopener">https://pub.dartlang.org/packages/flutter_bloc</a></li>
<li><a href="https://felangel.github.io/bloc/" target="_blank" rel="noopener">https://felangel.github.io/bloc/</a></li>
<li><a href="https://github.com/felangel/bloc/tree/master/examples/" target="_blank" rel="noopener">https://github.com/felangel/bloc/tree/master/examples/</a></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://dragonetail.github.io/2019/03/12/面试故事-Java的Map篇/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黑哈">
      <meta itemprop="description" content="~黑哈等你回家~">
      <meta itemprop="image" content="/images/blackharry1.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="微笑卡卡西">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/03/12/面试故事-Java的Map篇/" class="post-title-link" itemprop="url">面试故事-Java的Map篇</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-03-12 11:23:56" itemprop="dateCreated datePublished" datetime="2019-03-12T11:23:56+08:00">2019-03-12</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-04-08 08:59:19" itemprop="dateModified" datetime="2019-04-08T08:59:19+08:00">2019-04-08</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/面试/" itemprop="url" rel="index"><span itemprop="name">面试</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在面试与被面之间游荡，把面试作为一项事情来做。</p>
<h1 id="营养早餐"><a href="#营养早餐" class="headerlink" title="营养早餐"></a>营养早餐</h1><h2 id="HashMap、Hashtable和TreeMap的区别"><a href="#HashMap、Hashtable和TreeMap的区别" class="headerlink" title="HashMap、Hashtable和TreeMap的区别"></a>HashMap、Hashtable和TreeMap的区别</h2><ol>
<li>都实现了Map接口，（Key，Value）元组存储逻辑概念，内部采用Hash（rehash）算法提供高效的访问速度。</li>
<li>Hash的计算依赖于Key的hashCode和equals实现。</li>
<li>HashMap允许null作为Key和Value出现，而Hashtable不允许，对于null键值会抛异常。（补充HashMap的null键值对应的value会被存储到内部条目Array的0位，业务层面可以作为默认值的用途来使用，个人意见是不建议使用，使用业务含义清晰的Key常量作为默认值也许会是更好的选择）。</li>
<li>Hashtable的方法是线程安全的，内部方法之间使用Synchronized同步保护；而HashMap和TreeMap需要使用者自己保障线程安全机制。</li>
<li>因为线程机制的原因，Hashmap的操作会比Hashtable更高效一些（对于Web环境编程的小白来说，正常业务上，建议直接使用Hashtable，除非遇到性能集中爆发的地方，再考虑HashMap吧。补充，Java5提供了一个ConcurrentHashMap，没有太多调查和详细对比，从JDK的API文档来看，是建议使用这个类替代Hashtable的）。</li>
<li>Hashtable和HashMap的iterator、keySet()、values()都是（类）视图方式返回，即fail-fast模式，这种模式下，除非用返回对象直接remove来变更Map，其他方式或进程对Map的修改，都会在下一次hasNext或者next方法的时候（有可能会）触发<a href="https://docs.oracle.com/javase/8/docs/api/java/util/ConcurrentModificationException.html" target="_blank" rel="noopener">ConcurrentModificationException</a>。Hashtable提供的keys()和elements()返回的<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Enumeration.html" target="_blank" rel="noopener">Enumeration</a>不是fail-fast模式的视图化操作模式，是clone模式。</li>
<li>迭代访问数据的顺序时，HashMap和Hashtable不保证数据的顺序，并且不能保证数据顺序根据时间保持不变；TreeMap能够根据键值的比较器迭代访问整个条目。</li>
<li>对于TreeMap，如果比较器不允许空值，使用null的Key会引发异常。</li>
<li>三个详细比较</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">                 | HashMap | Hashtable | TreeMap</span><br><span class="line">-------------------------------------------------------</span><br><span class="line">iteration order  | no      | no        | yes</span><br><span class="line">null key-value   | yes-yes | no-no     | no-yes</span><br><span class="line">synchronized     | no      | yes       | no</span><br><span class="line">time performance | O(1)    | O(1)      | O(log n)</span><br><span class="line">implementation   | buckets | buckets   | red-black tree</span><br></pre></td></tr></table></figure>
<h2 id="fail-fast与fail-safe"><a href="#fail-fast与fail-safe" class="headerlink" title="fail-fast与fail-safe"></a>fail-fast与fail-safe</h2><ol>
<li>这是对Java的Collections相关类的操作接口的一个实现和使用概念；</li>
<li>白话来说，fail-fast是以View（视图）的模式对原有Collection数据的访问，这个时候除了直接用View（通常是Iterator接口）进行remove对象，其他方式对原有Collection的增删改都可能会触ConcurrentModificationException](<a href="https://docs.oracle.com/javase/8/docs/api/java/util/ConcurrentModificationException.html)。" target="_blank" rel="noopener">https://docs.oracle.com/javase/8/docs/api/java/util/ConcurrentModificationException.html)。</a></li>
<li>而fail-safe则不是以View模式，而是以Clone模式。</li>
<li>fail-fast能够访问到最新的数据内容；fail-safe只能访问到clone时点的数据。</li>
<li>fail-fast通过算法框架控制访问，没有空间需求；fail-safe会clone数据，有空间需求，对于大的数据集合，需要注意。</li>
<li>简单的来说java.util下面的Collection对象都是使用fail-fast模式（不完全准确，个别特殊接口除外，例如Hashtable的keys()和elements()接口），常见例如：HashMap、Vector、ArrayList、HashSet；java.util.concurrent包下都是用fail-safe模式，例如：CopyOnWriteArrayList、ConcurrentHashMap。</li>
</ol>
<h2 id="红黑树（Red-black-Tree）"><a href="#红黑树（Red-black-Tree）" class="headerlink" title="红黑树（Red-black Tree）"></a>红黑树（Red-black Tree）</h2><p>红黑树（Red–black tree）同AVL（根据发明者Adelson-Velsky 和 Landis命名）都是一种<a href="https://zh.wikipedia.org/wiki/%E8%87%AA%E5%B9%B3%E8%A1%A1%E4%BA%8C%E5%8F%89%E6%9F%A5%E6%89%BE%E6%A0%91" target="_blank" rel="noopener">自平衡二叉查找树</a>，都对插入时间、删除时间和查找时间提供了最好可能的最坏情况担保。除了O(log n)的时间之外，红黑树的持久版本对每次插入或删除需要 O(log n)的空间。</p>
<p>红黑树的特点：</p>
<ul>
<li>节点是红色或黑色。</li>
<li>根是黑色。</li>
<li>所有叶子都是黑色（叶子是NIL节点）。</li>
<li>每个红色节点必须有两个黑色的子节点。（从每个叶子到根的所有路径上不能有两个连续的红色节点。）</li>
<li>从任一节点到其每个叶子的所有简单路径都包含相同数目的黑色节点。</li>
</ul>
<p>这些约束确保了红黑树的关键特性：从根到叶子的最长的可能路径不多于最短的可能路径的两倍长。结果是这个树大致上是平衡的。因为操作比如插入、删除和查找某个值的最坏情况时间都要求与树的高度成比例，这个在高度上的理论上限允许红黑树在最坏情况下都是高效的，而不同于普通的二叉查找树。</p>
<h2 id="Map相关常用操作"><a href="#Map相关常用操作" class="headerlink" title="Map相关常用操作"></a>Map相关常用操作</h2><p>遍历数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(Entry entry: map.entrySet()) &#123;</span><br><span class="line">  <span class="comment">// get key</span></span><br><span class="line">  K key = entry.getKey();</span><br><span class="line">  <span class="comment">// get value</span></span><br><span class="line">  V value = entry.getValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Iterator itr = map.entrySet().iterator();</span><br><span class="line"><span class="keyword">while</span>(itr.hasNext()) &#123;</span><br><span class="line">  Entry entry = itr.next();</span><br><span class="line">  <span class="comment">// get key</span></span><br><span class="line">  K key = entry.getKey();</span><br><span class="line">  <span class="comment">// get value</span></span><br><span class="line">  V value = entry.getValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据Key排序（需要业务保障Key不能出现null）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">List list = <span class="keyword">new</span> ArrayList(map.entrySet());</span><br><span class="line">Collections.sort(list, <span class="keyword">new</span> Comparator() &#123;</span><br><span class="line"> </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Entry e1, Entry e2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> e1.getKey().compareTo(e2.getKey());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>使用TreeMap排序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SortedMap sortedMap = <span class="keyword">new</span> TreeMap(<span class="keyword">new</span> Comparator() &#123;</span><br><span class="line"> </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(K k1, K k2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> k1.compareTo(k2);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line">sortedMap.putAll(map);</span><br></pre></td></tr></table></figure>
<p>根据Value进行排序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">List list = <span class="keyword">new</span> ArrayList(map.entrySet());</span><br><span class="line">Collections.sort(list, <span class="keyword">new</span> Comparator() &#123;</span><br><span class="line"> </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Entry e1, Entry e2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> e1.getValue().compareTo(e2.getValue());</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>静态Map</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map map;  <span class="comment">//并能真的内容静态，使用的代码仍然能够使用put方法操作Map对象的内容</span></span><br><span class="line">  <span class="keyword">static</span> &#123;</span><br><span class="line">    map = <span class="keyword">new</span> HashMap();</span><br><span class="line">    map.put(<span class="number">1</span>, <span class="string">"one"</span>);</span><br><span class="line">    map.put(<span class="number">2</span>, <span class="string">"two"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map map;</span><br><span class="line">  <span class="keyword">static</span> &#123;</span><br><span class="line">    Map aMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">    aMap.put(<span class="number">1</span>, <span class="string">"one"</span>);</span><br><span class="line">    aMap.put(<span class="number">2</span>, <span class="string">"two"</span>);</span><br><span class="line">    map = Collections.unmodifiableMap(aMap);  <span class="comment">//固化保护Map的内容是静态</span></span><br><span class="line">    						<span class="comment">//如果使用put方法，将会抛出UnsupportedOperationException</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="双向映射Map"><a href="#双向映射Map" class="headerlink" title="双向映射Map"></a>双向映射Map</h2><p>有时，我们需要一组键对，互相映射，允许通过Key查找，也允许通过Value“反向查找”。JDK不支持双向映射，需要使用两个Map对象来进行保存和处理。</p>
<p>Apache Common Collections 和 Guava 的 <a href="https://commons.apache.org/proper/commons-collections/javadocs/api-3.2.1/org/apache/commons/collections/BidiMap.html" target="_blank" rel="noopener"><strong>BidiMap</strong></a>and <a href="https://guava-libraries.googlecode.com/svn/tags/release09/javadoc/com/google/common/collect/BiMap.html" target="_blank" rel="noopener"><strong>BiMap</strong></a>都实现了这类功能。</p>
<h2 id="Map拷贝"><a href="#Map拷贝" class="headerlink" title="Map拷贝"></a>Map拷贝</h2><p>多数Map实现类都实现了使用构造方法，传入另外一个Collection对象来实现数据的内容的复制，但是这个复制不是同步的，会出现上面的fail-fast问题（<font color="red">TODO 需要探究或验证</font>）。</p>
<p>正确的用法是使用Collections.synchronizedMap()。</p>
<h2 id="空Map"><a href="#空Map" class="headerlink" title="空Map"></a>空Map</h2><p>很少会有需要，但是某个时候调用一些接口需要Map，但是不需要数据的时候创建一个空Map也是需要的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">map = Collections.emptyMap();  <span class="comment">//返回的是内容也不可变的Map</span></span><br><span class="line"></span><br><span class="line">map = <span class="keyword">new</span> HashMap();</span><br></pre></td></tr></table></figure>
<h2 id="LinkedHashMap"><a href="#LinkedHashMap" class="headerlink" title="LinkedHashMap"></a><a href="https://www.programcreek.com/2013/03/hashmap-vs-treemap-vs-hashtable-vs-linkedhashmap/" target="_blank" rel="noopener">LinkedHashMap</a></h2><ol start="7">
<li><p>同TreeMap和HashMap一样，特殊的是其迭代顺序是其插入的顺序；并且根据这个<a href="https://www.baeldung.com/java-linked-hashmap" target="_blank" rel="noopener">博客</a>来看，每次通过Get操作访问其内的元素，会把其访问的元素放到最尾的地方，改变迭代的顺序（<font color="red">如下示例验证</font>）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.util.Assert;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LinkedHashMapTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> LinkedHashMap&lt;Integer, String&gt; map = <span class="keyword">new</span> LinkedHashMap&lt;&gt;(<span class="number">16</span>, .<span class="number">75f</span>, <span class="keyword">true</span>);</span><br><span class="line">        map.put(<span class="number">1</span>, <span class="keyword">null</span>);</span><br><span class="line">        map.put(<span class="number">2</span>, <span class="keyword">null</span>);</span><br><span class="line">        map.put(<span class="number">3</span>, <span class="keyword">null</span>);</span><br><span class="line">        map.put(<span class="number">4</span>, <span class="keyword">null</span>);</span><br><span class="line">        map.put(<span class="number">5</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> Set&lt;Integer&gt; keys = map.keySet();</span><br><span class="line">        Assert.isTrue(<span class="string">"[1, 2, 3, 4, 5]"</span>.equals(keys.toString()), <span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">        map.get(<span class="number">4</span>);</span><br><span class="line">        Assert.isTrue(<span class="string">"[1, 2, 3, 5, 4]"</span>.equals(keys.toString()), <span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">        map.get(<span class="number">1</span>);</span><br><span class="line">        Assert.isTrue(<span class="string">"[2, 3, 5, 4, 1]"</span>.equals(keys.toString()), <span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">        map.get(<span class="number">3</span>);</span><br><span class="line">        Assert.isTrue(<span class="string">"[2, 5, 4, 1, 3]"</span>.equals(keys.toString()), <span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"OK"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>其时间复杂度，同HashMap一样，内部使用buckets实现，但是其迭代的时间复杂度因为有Link的存在，仅与其元素个数有关，而HashMap的迭代时间复杂度跟其容量有关。</p>
</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://dragonetail.github.io/2019/03/07/Spring-JWT实现微服务集群/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黑哈">
      <meta itemprop="description" content="~黑哈等你回家~">
      <meta itemprop="image" content="/images/blackharry1.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="微笑卡卡西">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/03/07/Spring-JWT实现微服务集群/" class="post-title-link" itemprop="url">Spring+JWT实现微服务集群</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-03-07 17:02:00" itemprop="dateCreated datePublished" datetime="2019-03-07T17:02:00+08:00">2019-03-07</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-04-08 08:59:19" itemprop="dateModified" datetime="2019-04-08T08:59:19+08:00">2019-04-08</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/技术/" itemprop="url" rel="index"><span itemprop="name">技术</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这是一个练习项目，来源于网上一个需求，很感兴趣，就自己做了一个DEMO。</p>
<p>之前这类工作大刘同学做的比较多，就当想念他一下吧。</p>
<h1 id="Spring-JWT实现基础微服务"><a href="#Spring-JWT实现基础微服务" class="headerlink" title="Spring+JWT实现基础微服务"></a>Spring+JWT实现基础微服务</h1><p>Spring使用微服务，有完整的Cloud组件协助完成。但是通常Cloud太过庞大，很多小的项目需要一定的业务拆分，但是业务组件之间可能不需要使用Cloud那么庞大的管理。</p>
<h2 id="主要功能"><a href="#主要功能" class="headerlink" title="主要功能"></a>主要功能</h2><p>这个Demo就是针对这个目的设立的，主要完成了：</p>
<ul>
<li>使用JWT实现了无Session化的访问控制，适合前端APP类的接入</li>
<li>使用了一个OAuthServer服务器，完成认证工作（授权的部分Dummy了，很容易扩展）</li>
<li>实现了一个Miscroservcie1作为微服务组件1，模拟获取用户的基本信息</li>
<li>实现了一个Miscroservcie2作为微服务组件2，模拟获取用户的技能信息（多条技能）</li>
</ul>
<h2 id="业务流程："><a href="#业务流程：" class="headerlink" title="业务流程："></a>业务流程：</h2><ul>
<li>用户通过OAuthServer进行Login认证，获取JWT Token</li>
<li>通过JWT Token访问Miscroservcie1，获取用户的基本信息和技能信息</li>
<li>Miscroservcie1中，传递JWT Token到Miscroservcie2，获取技能信息，同基本信息一起打包返回给前端</li>
</ul>
<p>很简单的需求，代码也没有复杂的地方，核心在Miscroservcie1通过ThreadLocal和RestTemplateInterceptor实现了基于RestTemplate的JWT Token的透传，完成的级联认证。</p>
<h2 id="在项目中使用可以优化的内容："><a href="#在项目中使用可以优化的内容：" class="headerlink" title="在项目中使用可以优化的内容："></a>在项目中使用可以优化的内容：</h2><ul>
<li>JWT Token中如何封装授权信息，还是由Miscroservcie通过接口访问OAuthServer来获取</li>
<li>Miscroservcie拿到JWT Token后，是否需要向OAuthServer进行增强验证</li>
<li>结合上面两个需求，理想的方案还是JWT Token尽可能简单，只有Principal的ID（用户ID）和超时等JWT信息，其他附加业务信息通过OAuthServer来提供比较好，当然Miscroservcie可以缓存，或者整体使用缓存集群（例如Hazelcast来实现）会更好</li>
</ul>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>好吧，所有的都在代码中了： <a href="https://github.com/dragonetail/MicroservicesJwtOAuth" target="_blank" rel="noopener">MicroservicesJwtOAuth</a></p>
<p>（本页梳理耗时30分钟）</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://dragonetail.github.io/2019/03/07/看HTTP演变论基础科技发展与创新/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黑哈">
      <meta itemprop="description" content="~黑哈等你回家~">
      <meta itemprop="image" content="/images/blackharry1.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="微笑卡卡西">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/03/07/看HTTP演变论基础科技发展与创新/" class="post-title-link" itemprop="url">看HTTP演变论基础科技发展与创新</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-03-07 16:35:48" itemprop="dateCreated datePublished" datetime="2019-03-07T16:35:48+08:00">2019-03-07</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-04-08 08:59:19" itemprop="dateModified" datetime="2019-04-08T08:59:19+08:00">2019-04-08</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/杂谈/" itemprop="url" rel="index"><span itemprop="name">杂谈</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>早上通过微信看了这篇【<a href="https://mp.weixin.qq.com/s/EYRFmYdNm63DcjjZcancLw" target="_blank" rel="noopener">HTTP3 为什么比 HTTP2 靠谱？ | 技术头条</a>】，标题有点大，内容却是十分充实细腻的。文章最后总结主要说了三个问题：</p>
<ul>
<li>HTTP/1.x 有连接无法复用、队头阻塞、协议开销大和安全因素等多个缺陷；</li>
<li>HTTP/2 通过多路复用、二进制流、Header 压缩等等技术，极大地提高了性能，但是还是存在着问题的；</li>
<li>QUIC 基于 UDP 实现，是 HTTP/3 中的底层支撑协议，该协议基于 UDP，又取了 TCP 中的精华，实现了即快又可靠的协议。</li>
</ul>
<p>但是整篇细读看下来，文章隐藏了进一步的几个要点或问题可以进一步阐述：</p>
<ul>
<li>HTTP/1.x 各种问题，但是是目前网络基石，不过可以简单替换</li>
<li>HTTP/2标准于2015年5月以RFC 7540正式发表，根据<a href="https://zh.wikipedia.org/w/index.php?title=W3Techs&amp;action=edit&amp;redlink=1" target="_blank" rel="noopener">W3Techs</a>的数据，在2017年5月，在排名前一千万的网站中，有13.7%支持了HTTP/2，尚远远没有普及</li>
<li>QUIC也就是HTTP/3，目前貌似只有一个Go开发的Caddy未来服务器支持，客户端应该也只有Chrome一家吧，不过看过一些文章，貌似稳定性还需要一些时间</li>
<li>HTTP是这个样子，可以持续发展进化，虽然代价昂贵</li>
<li>但是TCP、UDP这两个基础协议目前尚无持续发展的规划</li>
<li>SSH貌似前一段看已过一个替代方案，忘记了名字</li>
</ul>
<p>细细看来，其实说明了一个基本问题： 越是基础的，越是被广泛应用的，替换更新的代价就越高。</p>
<p>再细看一下，一个产品的规划、上线、推广、升级，一旦到了一定规模，其维护、升级的成本会成级数上涨。但结合商务的同学想法，一个产品要快快下海试水，能不淹死才能继续投入，想想也没有错，商务技术互相商量平衡吧。就怕前面商务铺的大了，技术投入深了，有了基础了，需要在进一步加大投入的时候，商务说看不到岸了，模模糊糊停了，很想学学BigBang中那么直白的说，不过还是算了。</p>
<p>总结一下，上面的文章值得细细看，结束。（回头看看标题，貌似标准的乱水😂）</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/blackharry1.png" alt="黑哈">
            
              <p class="site-author-name" itemprop="name">黑哈</p>
              <div class="site-description motion-element" itemprop="description">~黑哈等你回家~</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">15</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">11</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">28</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/dragonetail" title="GitHub &rarr; https://github.com/dragonetail" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">黑哈</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.0.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>












  















  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  

  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  
  



  




  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
